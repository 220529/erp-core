# erp-core - æŠ€æœ¯æ¶æ„

> **æœ€åæ›´æ–°**: 2025-12-01

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

erp-core æ˜¯ ERP ç³»ç»Ÿçš„åç«¯æœåŠ¡ï¼ŒåŸºäº NestJS æ¡†æ¶æ„å»ºï¼Œæä¾› REST API æ¥å£ï¼Œæ”¯æŒå®¢æˆ·ã€è®¢å•ã€é¡¹ç›®ã€ç‰©æ–™ç­‰æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… æ¨¡å—åŒ–æ¶æ„è®¾è®¡
- âœ… TypeORM å¯¹è±¡å…³ç³»æ˜ å°„
- âœ… JWT è®¤è¯æˆæƒ
- âœ… Swagger API æ–‡æ¡£
- âœ… åŠ¨æ€ä¸šåŠ¡æµç¨‹å¼•æ“
- âœ… Redis ç¼“å­˜æ”¯æŒ

---

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **NestJS** | 11.0+ | åç«¯æ¡†æ¶ |
| **TypeScript** | 5.7+ | å¼€å‘è¯­è¨€ |
| **TypeORM** | 0.3.27 | ORM æ¡†æ¶ |
| **MySQL** | 8.0 | å…³ç³»æ•°æ®åº“ |
| **Redis** | 7+ | ç¼“å­˜å’Œä¼šè¯ |
| **Passport** | - | è®¤è¯ä¸­é—´ä»¶ |
| **JWT** | 11.0+ | ä»¤ç‰Œè®¤è¯ |
| **Swagger** | 11.2+ | API æ–‡æ¡£ |
| **Axios** | 1.13+ | HTTP å®¢æˆ·ç«¯ |
| **Bcrypt** | 3.0+ | å¯†ç åŠ å¯† |

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
erp-core/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                 # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ app.module.ts           # æ ¹æ¨¡å—
â”‚   â”œâ”€â”€ common/                 # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ decorators/        # è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ filters/           # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”‚   â”œâ”€â”€ guards/            # å®ˆå«
â”‚   â”‚   â”œâ”€â”€ interceptors/      # æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ pipes/             # ç®¡é“
â”‚   â”œâ”€â”€ config/                 # é…ç½®æ¨¡å—
â”‚   â”‚   â””â”€â”€ configuration.ts
â”‚   â”œâ”€â”€ database/               # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ data-source.ts
â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â”œâ”€â”€ modules/                # ä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/              # è®¤è¯æˆæƒ
â”‚   â”‚   â”œâ”€â”€ user/              # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ customer/          # å®¢æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ order/             # è®¢å•ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ project/           # é¡¹ç›®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ material/          # ç‰©æ–™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ payment/           # è´¢åŠ¡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ company/           # å…¬å¸ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ dict/              # å­—å…¸ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ business-flow/     # ä¸šåŠ¡æµç¨‹å¼•æ“
â”‚   â”‚   â””â”€â”€ upload/            # æ–‡ä»¶ä¸Šä¼ 
â”‚   â””â”€â”€ entities/               # å®ä½“å®šä¹‰ï¼ˆå¯é€‰ï¼Œé€šå¸¸åœ¨æ¨¡å—å†…ï¼‰
â”œâ”€â”€ test/                       # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ migrations/                 # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ scripts/                    # å·¥å…·è„šæœ¬
â”œâ”€â”€ Dockerfile                  # Docker æ„å»º
â”œâ”€â”€ docker-compose.prod.yml     # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ .env                        # å¼€å‘ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.prod                   # ç”Ÿäº§ç¯å¢ƒå˜é‡
â””â”€â”€ nest-cli.json               # NestJS CLI é…ç½®
```

---

## ğŸ¯ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API Layer (Controllers)      â”‚  HTTP è¯·æ±‚å¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Business Layer (Services)       â”‚  ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Data Layer (Repositories)        â”‚  æ•°æ®è®¿é—®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Database (MySQL/Redis)        â”‚  æ•°æ®å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—æ¶æ„

```mermaid
graph TB
    App[AppModule]
    
    App --> Auth[AuthModule]
    App --> User[UserModule]
    App --> Customer[CustomerModule]
    App --> Order[OrderModule]
    App --> Project[ProjectModule]
    App --> Material[MaterialModule]
    App --> Payment[PaymentModule]
    App --> Dict[DictModule]
    App --> Flow[BusinessFlowModule]
    
    Auth --> DB[(Database)]
    User --> DB
    Customer --> DB
    Order --> DB
    
    Auth --> Cache[(Redis)]
    Flow --> Cache
```

### ä¾èµ–æ³¨å…¥

NestJS ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼š

```typescript
@Module({
  imports: [TypeOrmModule.forFeature([Customer])],
  controllers: [CustomerController],
  providers: [CustomerService],
  exports: [CustomerService],
})
export class CustomerModule {}

@Injectable()
export class CustomerService {
  constructor(
    @InjectRepository(Customer)
    private customerRepository: Repository<Customer>,
  ) {}
}
```

---

## ğŸ”’ è®¤è¯æˆæƒ

### JWT è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant Controller
    participant AuthService
    participant UserService
    participant DB

    Client->>Controller: POST /auth/login
    Controller->>AuthService: validateUser(username, password)
    AuthService->>UserService: findByUsername(username)
    UserService->>DB: SELECT user
    DB->>UserService: user data
    UserService->>AuthService: user
    AuthService->>AuthService: bcrypt.compare(password)
    AuthService->>AuthService: sign JWT token
    AuthService->>Controller: { access_token }
    Controller->>Client: { access_token }
```

### Guard å®ˆå«

```typescript
// JWT å®ˆå«
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}

// ä½¿ç”¨å®ˆå«ä¿æŠ¤è·¯ç”±
@Controller('customers')
@UseGuards(JwtAuthGuard)
export class CustomerController {
  @Get()
  findAll() {
    // åªæœ‰æºå¸¦æœ‰æ•ˆ JWT çš„è¯·æ±‚æ‰èƒ½è®¿é—®
  }
}
```

---

## ğŸ’¼ æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

### å®¢æˆ·ç®¡ç† (Customer)

**å®ä½“è®¾è®¡**:

```typescript
@Entity()
export class Customer {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column({ nullable: true })
  phone: string;

  @Column({
    type: 'enum',
    enum: ['çº¿ç´¢', 'é‡æˆ¿', 'æŠ¥ä»·', 'ç­¾çº¦', 'å®Œå·¥'],
  })
  status: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'created_by' })
  createdBy: User;

  @OneToMany(() => Order, order => order.customer)
  orders: Order[];
}
```

**Service å±‚**:

```typescript
@Injectable()
export class CustomerService {
  constructor(
    @InjectRepository(Customer)
    private repository: Repository<Customer>,
  ) {}

  async findAll(params: any) {
    return await this.repository.find({
      relations: ['createdBy', 'orders'],
      where: params,
    });
  }
}
```

### è®¢å•ç®¡ç† (Order)

**å…³é”®åŠŸèƒ½**:
- è®¢å•CRUD
- çŠ¶æ€æµè½¬ (è‰ç¨¿â†’ç­¾çº¦â†’æ–½å·¥â†’å®Œå·¥)
- ç‰©æ–™å…³è”
- é‡‘é¢è®¡ç®—

**æ•°æ®å…³ç³»**:
```
Order 1:N OrderMaterial
Order N:1 Customer
Order 1:N Project
Order 1:N Payment
```

### ä¸šåŠ¡æµç¨‹å¼•æ“ (BusinessFlow)

**è®¾è®¡ç†å¿µ**: åŠ¨æ€æ‰§è¡Œä¸šåŠ¡é€»è¾‘

```typescript
@Injectable()
export class BusinessFlowService {
  async runFlow(flowKey: string, context: any) {
    // 1. ä»æ•°æ®åº“è·å–æµç¨‹ä»£ç 
    const flow = await this.findByKey(flowKey);
    
    // 2. æ³¨å…¥ä¾èµ–ï¼ˆrepositories, å‚æ•°, ç”¨æˆ·ä¿¡æ¯ï¼‰
    const flowContext = {
      repositories: this.buildRepositories(),
      params: context.params,
      user: context.user,
    };
    
    // 3. æ‰§è¡Œæµç¨‹ä»£ç 
    const func = new Function('context', flow.code);
    const result = await func(flowContext);
    
    return result;
  }
}
```

---

## ğŸ“ æ•°æ®åº“è®¾è®¡

### TypeORM é…ç½®

```typescript
// database/data-source.ts
export const AppDataSource = new DataSource({
  type: 'mysql',
  host: process.env.DB_HOST,
  port: +process.env.DB_PORT,
  username: process.env.DB_USERNAME,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_DATABASE,
  entities: [__dirname + '/../**/*.entity{.ts,.js}'],
  migrations: [__dirname + '/migrations/*{.ts,.js}'],
  synchronize: false,  // ç”Ÿäº§ç¯å¢ƒå¿…é¡»å…³é—­
  logging: process.env.NODE_ENV === 'development',
});
```

### Migration æµç¨‹

```bash
# ç”Ÿæˆ migration
pnpm migration:generate src/migrations/AddCustomerTable

# è¿è¡Œ migration
pnpm migration:run

# å›æ»š migration
pnpm migration:revert
```

### æ ¸å¿ƒå®ä½“å…³ç³»

``typescript
// ä¸€å¯¹å¤šå…³ç³»
@Entity()
export class Customer {
  @OneToMany(() => Order, order => order.customer)
  orders: Order[];
}

@Entity()
export class Order {
  @ManyToOne(() => Customer, customer => customer.orders)
  @JoinColumn({ name: 'customer_id' })
  customer: Customer;
}
```

---

## ğŸš€ API è®¾è®¡

### RESTful è§„èŒƒ

| Method | Path | è¯´æ˜ |
|--------|------|------|
| GET | /api/customers | è·å–å®¢æˆ·åˆ—è¡¨ |
| GET | /api/customers/:id | è·å–å®¢æˆ·è¯¦æƒ… |
| POST | /api/customers | åˆ›å»ºå®¢æˆ· |
| PUT | /api/customers/:id | æ›´æ–°å®¢æˆ· |
| DELETE | /api/customers/:id | åˆ é™¤å®¢æˆ· |

### å“åº”æ ¼å¼

```typescript
// æˆåŠŸå“åº”
{
  "success": true,
  "data": { ... },
  "message": "æ“ä½œæˆåŠŸ"
}

// é”™è¯¯å“åº”
{
  "success": false,
  "message": "é”™è¯¯ä¿¡æ¯",
  "error": "ERROR_CODE"
}
```

### Swagger æ–‡æ¡£

```typescript
@Controller('customers')
@ApiTags('å®¢æˆ·ç®¡ç†')
export class CustomerController {
  @Get()
  @ApiOperation({ summary: 'è·å–å®¢æˆ·åˆ—è¡¨' })
  @ApiResponse({ status: 200, description: 'æˆåŠŸ' })
  findAll() {}
}
```

---

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡

```env
# .env (å¼€å‘ç¯å¢ƒ)
NODE_ENV=development
PORT=3009

DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=root
DB_DATABASE=erp_core
DB_SYNCHRONIZE=true

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis123

JWT_SECRET=dev_secret_key
JWT_EXPIRES_IN=7d
```

### ConfigModule

```typescript
@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: `.env.${process.env.NODE_ENV}`,
    }),
  ],
})
export class AppModule {}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```typescript
// âŒ N+1 æŸ¥è¯¢
const orders = await orderRepository.find();
for (const order of orders) {
  order.customer = await customerRepository.findOne(order.customerId);
}

// âœ… ä½¿ç”¨ relations ä¸€æ¬¡æŸ¥è¯¢
const orders = await orderRepository.find({
  relations: ['customer', 'materials'],
});

// âœ… ä½¿ç”¨ QueryBuilder å¤æ‚æŸ¥è¯¢
const orders = await orderRepository
  .createQueryBuilder('order')
  .leftJoinAndSelect('order.customer', 'customer')
  .where('customer.status = :status', { status: 'ç­¾çº¦' })
  .getMany();
```

### Redis ç¼“å­˜

```typescript
@Injectable()
export class DictService {
  constructor(
    @InjectRedis() private readonly redis: Redis,
  ) {}

  async getDictByType(type: string) {
    const cacheKey = `dict:${type}`;
    const cached = await this.redis.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }
    
    const data = await this.repository.find({ where: { type } });
    await this.redis.setex(cacheKey, 3600, JSON.stringify(data));
    
    return data;
  }
}
```

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```typescript
describe('CustomerService', () => {
  let service: CustomerService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [CustomerService],
    }).compile();

    service = module.get<CustomerService>(CustomerService);
  });

  it('should find all customers', async () => {
    const result = await service.findAll({});
    expect(result).toBeDefined();
  });
});
```

### E2E æµ‹è¯•

```bash
pnpm test:e2e
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ¶æ„](./éƒ¨ç½²æ¶æ„.md)
- [ä¼˜åŒ–å»ºè®®](./ä¼˜åŒ–å»ºè®®.md)
- [NestJS å®˜æ–¹æ–‡æ¡£](https://docs.nestjs.com/)
- [TypeORM å®˜æ–¹æ–‡æ¡£](https://typeorm.io/)

---

**æ¶æ„è®¾è®¡: ç®€æ´ã€å¯ç»´æŠ¤ã€å¯æ‰©å±•** ğŸ—ï¸
