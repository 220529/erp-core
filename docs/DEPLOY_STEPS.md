# erp-core äº‘æ•ˆéƒ¨ç½²æ“ä½œæ‰‹å†Œ

## ğŸ“‹ é…ç½®æ¸…å•

åœ¨å¼€å§‹ä¹‹å‰,è¯·å‡†å¤‡ä»¥ä¸‹ä¿¡æ¯:

### é˜¿é‡Œäº‘ä¿¡æ¯
- [ ] é˜¿é‡Œäº‘è´¦å· (ç”¨æˆ·å)
- [ ] å®¹å™¨é•œåƒæœåŠ¡ Registry å¯†ç 
- [ ] å‘½åç©ºé—´åç§° (ä¾‹å¦‚: `erp-system`)
- [ ] é•œåƒä»“åº“åœ°å€ (ä¾‹å¦‚: `registry.cn-hangzhou.aliyuncs.com/erp-system/erp-core`)

### æœåŠ¡å™¨ä¿¡æ¯
- [ ] æœåŠ¡å™¨ IP åœ°å€
- [ ] SSH ç”¨æˆ·å (é€šå¸¸æ˜¯ `root`)
- [ ] SSH ç§é’¥

### åº”ç”¨é…ç½®
- [ ] æ•°æ®åº“åœ°å€
- [ ] æ•°æ®åº“å¯†ç 
- [ ] JWT å¯†é’¥
- [ ] ä¸Šä¼ å¯†é’¥

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åœ¨äº‘æ•ˆåˆ›å»ºæµæ°´çº¿

1. ç™»å½•äº‘æ•ˆæ§åˆ¶å°
2. ç‚¹å‡» "æµæ°´çº¿" â†’ "æ–°å»ºæµæ°´çº¿"
3. é€‰æ‹© "è‡ªå®šä¹‰æµæ°´çº¿"
4. æµæ°´çº¿åç§°: `erp-core-deploy`
5. é€‰æ‹©ä»£ç æº: é€‰æ‹©æ‚¨çš„ erp-core ä»“åº“
6. åˆ†æ”¯: `main` æˆ– `master`

### 2. é…ç½®æµæ°´çº¿

**æ–¹å¼ A: ä½¿ç”¨ YAML é…ç½® (æ¨è)**

1. åœ¨æµæ°´çº¿ç¼–è¾‘é¡µé¢,åˆ‡æ¢åˆ° "YAML æ¨¡å¼"
2. å¤åˆ¶ `.workflow/pipeline.yml` çš„å†…å®¹
3. ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­
4. ä¿å­˜

**æ–¹å¼ B: å¯è§†åŒ–é…ç½®**

1. æ·»åŠ "æ„å»º"é˜¶æ®µ:
   - é•œåƒ: `docker:latest`
   - è„šæœ¬: å¤åˆ¶ pipeline.yml ä¸­ build é˜¶æ®µçš„ script å†…å®¹
2. æ·»åŠ "éƒ¨ç½²"é˜¶æ®µ:
   - é•œåƒ: `alpine:latest`
   - è„šæœ¬: å¤åˆ¶ pipeline.yml ä¸­ deploy é˜¶æ®µçš„ script å†…å®¹

### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨æµæ°´çº¿è®¾ç½® â†’ ç¯å¢ƒå˜é‡ä¸­æ·»åŠ :

#### é•œåƒä»“åº“é…ç½®

| å˜é‡å | å€¼ | åŠ å¯† |
|--------|---|------|
| `ALI_REGISTRY_USER` | æ‚¨çš„é˜¿é‡Œäº‘è´¦å· | å¦ |
| `ALI_REGISTRY_PASSWORD` | Registry ç™»å½•å¯†ç  | âœ… æ˜¯ |
| `NAMESPACE` | erp-system | å¦ |

#### æœåŠ¡å™¨é…ç½®

| å˜é‡å | å€¼ | åŠ å¯† |
|--------|---|------|
| `SERVER_HOST` | æœåŠ¡å™¨ IP (ä¾‹å¦‚: 47.xxx.xxx.xxx) | å¦ |
| `SERVER_USER` | root | å¦ |
| `SSH_PRIVATE_KEY` | SSH ç§é’¥å†…å®¹ (è§ä¸‹æ–¹è¯´æ˜) | âœ… æ˜¯ |

#### åº”ç”¨é…ç½®

| å˜é‡å | å€¼ | åŠ å¯† |
|--------|---|------|
| `DB_HOST` | localhost æˆ–æ•°æ®åº“å®¹å™¨å | å¦ |
| `DB_PASSWORD` | æ•°æ®åº“å¯†ç  | âœ… æ˜¯ |
| `DB_DATABASE` | erp_core | å¦ |
| `REDIS_HOST` | localhost æˆ– Redis å®¹å™¨å | å¦ |
| `JWT_SECRET` | JWT å¯†é’¥ | âœ… æ˜¯ |
| `UPLOAD_ACCESS_SECRET` | ä¸Šä¼ å¯†é’¥ | âœ… æ˜¯ |

### 4. è·å– SSH ç§é’¥

**åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œ:**

```bash
# ç”Ÿæˆ SSH å¯†é’¥å¯¹ (å¦‚æœè¿˜æ²¡æœ‰)
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# æŸ¥çœ‹ç§é’¥å†…å®¹
cat ~/.ssh/id_rsa

# å¤åˆ¶æ•´ä¸ªè¾“å‡º (åŒ…æ‹¬ BEGIN å’Œ END è¡Œ)
# -----BEGIN RSA PRIVATE KEY-----
# ...
# -----END RSA PRIVATE KEY-----
```

**åœ¨æœåŠ¡å™¨ä¸Šæ·»åŠ å…¬é’¥:**

```bash
# æŸ¥çœ‹å…¬é’¥
cat ~/.ssh/id_rsa.pub

# å¤åˆ¶å…¬é’¥å†…å®¹,ç„¶ååœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ:
ssh root@your-server-ip
echo "ä½ çš„å…¬é’¥å†…å®¹" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### 5. å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ

**SSH åˆ°æœåŠ¡å™¨æ‰§è¡Œ:**

```bash
# 1. å®‰è£… Docker
curl -fsSL https://get.docker.com | bash
systemctl start docker
systemctl enable docker

# 2. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /var/www/erp/uploads
mkdir -p /var/www/erp/logs

# 3. ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
docker login --username=ä½ çš„é˜¿é‡Œäº‘è´¦å· registry.cn-hangzhou.aliyuncs.com
# è¾“å…¥ Registry å¯†ç 

# 4. å¯åŠ¨ MySQL (å¦‚æœè¿˜æ²¡æœ‰)
docker run -d \
  --name mysql \
  --restart unless-stopped \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç  \
  -e MYSQL_DATABASE=erp_core \
  -v mysql-data:/var/lib/mysql \
  mysql:8.0

# 5. å¯åŠ¨ Redis (å¦‚æœè¿˜æ²¡æœ‰)
docker run -d \
  --name redis \
  --restart unless-stopped \
  -p 6379:6379 \
  redis:7-alpine
```

### 6. è§¦å‘éƒ¨ç½²

**æ–¹å¼ A: æ¨é€ä»£ç è§¦å‘**

```bash
cd e:\erp\erp-core

# æäº¤ä»£ç 
git add .
git commit -m "feat: é…ç½®äº‘æ•ˆéƒ¨ç½²"
git push aliyun main
```

**æ–¹å¼ B: æ‰‹åŠ¨è§¦å‘**

1. è¿›å…¥äº‘æ•ˆæµæ°´çº¿
2. ç‚¹å‡» "è¿è¡Œ"
3. é€‰æ‹©åˆ†æ”¯: `main`
4. ç‚¹å‡» "ç¡®å®š"

### 7. æŸ¥çœ‹éƒ¨ç½²è¿›åº¦

1. åœ¨äº‘æ•ˆæ§åˆ¶å°æŸ¥çœ‹æµæ°´çº¿è¿è¡ŒçŠ¶æ€
2. ç‚¹å‡»å„é˜¶æ®µæŸ¥çœ‹è¯¦ç»†æ—¥å¿—
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ (çº¦ 5-10 åˆ†é’Ÿ)

### 8. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://your-server-ip:3009/api

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
ssh root@your-server-ip
docker ps | grep erp-core

# æŸ¥çœ‹æ—¥å¿—
docker logs -f erp-core
```

---

## âœ… éƒ¨ç½²æˆåŠŸæ ‡å¿—

- [ ] æµæ°´çº¿æ‰€æœ‰é˜¶æ®µéƒ½æ˜¾ç¤ºç»¿è‰² âœ…
- [ ] æœåŠ¡å™¨ä¸Š erp-core å®¹å™¨åœ¨è¿è¡Œ
- [ ] API å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] æ—¥å¿—æ²¡æœ‰é”™è¯¯ä¿¡æ¯

---

## ğŸ”„ åç»­æ›´æ–°

æ¯æ¬¡ä¿®æ”¹ä»£ç å:

```bash
git add .
git commit -m "æè¿°ä½ çš„ä¿®æ”¹"
git push aliyun main
```

æµæ°´çº¿ä¼šè‡ªåŠ¨:
1. æ„å»ºæ–°çš„ Docker é•œåƒ
2. æ¨é€åˆ°é•œåƒä»“åº“
3. éƒ¨ç½²åˆ°æœåŠ¡å™¨
4. é‡å¯æœåŠ¡

**å…¨ç¨‹è‡ªåŠ¨åŒ–,æ— éœ€æ‰‹åŠ¨æ“ä½œ!** ğŸ‰

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### æ„å»ºå¤±è´¥: æ— æ³•è¿æ¥åˆ° Docker daemon

**è§£å†³**: ç¡®ä¿æµæ°´çº¿é…ç½®ä¸­ä½¿ç”¨äº† `docker:dind` æœåŠ¡

### éƒ¨ç½²å¤±è´¥: SSH è¿æ¥è¢«æ‹’ç»

**è§£å†³**: 
1. æ£€æŸ¥ SSH_PRIVATE_KEY æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤æœåŠ¡å™¨ SSH ç«¯å£æ˜¯ 22
3. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®

### å®¹å™¨å¯åŠ¨å¤±è´¥

**è§£å†³**:
1. SSH åˆ°æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—: `docker logs erp-core`
2. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®æ­£ç¡®
3. ç¡®è®¤æ•°æ®åº“å’Œ Redis æ˜¯å¦è¿è¡Œ

### å¦‚ä½•å›æ»š?

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@your-server-ip

# ä½¿ç”¨ä¹‹å‰çš„é•œåƒç‰ˆæœ¬
docker stop erp-core
docker rm erp-core
docker run -d --name erp-core ... registry.cn-hangzhou.aliyuncs.com/erp-system/erp-core:<commit-sha>
```

---

## ğŸ“ è·å–å¸®åŠ©

- æŸ¥çœ‹æµæ°´çº¿æ—¥å¿—
- æŸ¥çœ‹å®¹å™¨æ—¥å¿—: `docker logs erp-core`
- æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
- ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
