# 架构简化说明

## 📌 背景

根据老系统（t1-api、t1-code、t1-api-v2）的实际业务流程，发现：
- 老系统中**没有项目（Project）概念**
- 订单本身就包含了施工管理的职责
- 业务流程是：**客户 → 订单 → 收款**

为遵循"**不过度设计，业务闭环，流程精简**"的原则，我们决定去除 Project 项目表，简化系统架构。

---

## ✅ 已完成的变更

### 1. 删除的文件

```
src/entities/project.entity.ts                    # 项目实体
src/modules/projects/projects.module.ts           # 项目模块
src/modules/projects/projects.controller.ts       # 项目控制器
src/modules/projects/projects.service.ts          # 项目服务
src/modules/projects/dto/create-project.dto.ts    # 创建项目DTO
src/modules/projects/dto/update-project.dto.ts    # 更新项目DTO
src/modules/projects/dto/query-project.dto.ts     # 查询项目DTO
```

### 2. 清理的引用

- ✅ `src/entities/index.ts` - 移除 Project 导出
- ✅ `src/modules/code/code.module.ts` - 移除 Project 导入和注册
- ✅ `src/modules/code/code-executor.service.ts` - 移除 projectRepository
- ✅ `src/main.ts` - 移除 'projects' Swagger 标签
- ✅ `src/app.module.ts` - 已移除 ProjectsModule 导入

### 3. 创建的文档

- ✅ `docs/simplified-business-flow.md` - 简化版业务流程文档
- ✅ `docs/架构简化说明.md` - 本文档

---

## 🔄 架构对比

### 简化前（过度设计）

```
┌─────────────┐
│  Customer   │  1:N  ┌─────────────┐  1:N  ┌─────────────┐
│   客户表     │ ────▶ │   Order     │ ────▶ │  Project    │
│             │       │   订单表     │       │   项目表     │
└─────────────┘       └─────────────┘       └─────────────┘
      │                      │                      │
      ▼                      ▼                      ▼
  客户状态               订单状态               项目状态
  5个阶段                5个阶段                4个阶段
```

**问题：**
- 订单和项目职责不清
- 状态同步复杂（订单状态 ↔ 项目状态）
- 数据冗余（项目中需同时关联 orderId 和 customerId）

### 简化后（精简设计）✅

```
┌─────────────┐
│  Customer   │  1:N  ┌─────────────┐
│   客户表     │ ────▶ │   Order     │
│             │       │ 订单表（含施工）│
└─────────────┘       └─────────────┘
      │                      │
      ▼                      ▼
  客户状态               订单状态（含施工状态）
  5个阶段              5个阶段 (draft/signed/in_progress/completed/cancelled)
                           + foremanId（工长）
                           + startedAt（开工时间）
                           + completedAt（完工时间）
```

**优势：**
- ✅ 职责清晰：订单 = 商务 + 施工
- ✅ 状态统一：只需维护订单状态
- ✅ 数据精简：无冗余关联

---

## 📊 订单表字段说明

订单表（`orders`）现在承载双重职责：

### 商务相关字段
```typescript
orderNo: string;           // 订单编号
customerId: number;        // 客户ID
totalAmount: number;       // 订单总金额
paidAmount: number;        // 已收金额
costAmount: number;        // 成本金额
salesId: number;           // 销售ID
designerId: number;        // 设计师ID
signedAt: Date;            // 签约时间
```

### 施工相关字段
```typescript
foremanId: number;         // 工长ID（新增重点关注）
startedAt: Date;           // 开工时间（新增重点关注）
completedAt: Date;         // 完工时间（新增重点关注）
status: OrderStatus;       // 订单状态（包含施工状态）
```

### 订单状态枚举
```typescript
export enum OrderStatus {
  DRAFT = 'draft',           // 草稿
  SIGNED = 'signed',         // 已签约
  IN_PROGRESS = 'in_progress', // 施工中 ← 施工状态
  COMPLETED = 'completed',     // 已完工 ← 施工状态
  CANCELLED = 'cancelled',     // 已取消
}
```

---

## 🔄 业务流程对比

### 老系统流程（实际）
```
1. 设计师创建客户
2. 客户详情 → 转订单（选产品套餐）
3. 订单详情 → 完善材料
4. 订单状态流转（包含施工状态）
5. 财务收款
```

### 简化后的新系统（完全匹配）✅
```
1. 销售/设计师创建客户
2. 客户跟进（量房）
3. 创建订单草稿（选材料、报价）
4. 订单签约
5. 订单开工（分配工长、施工中）
6. 订单完工
7. 财务收款
```

**核心数据流：** `Customer → Order → Payment`（**完全一致**）

---

## 📝 业务场景示例

### 场景：订单开工

**简化前（复杂）：**
```javascript
// 1. 创建项目
POST /api/projects/create
{
  "orderId": 1,
  "name": "望京SOHO装修项目",
  "foremanId": 3001
}

// 2. 项目开工
POST /api/projects/1/start

// 3. 同步更新订单状态
// (自动或手动触发)
```

**简化后（直接）：** ✅
```javascript
// 直接操作订单
POST /api/code/run/order_start
{
  "params": {
    "orderId": 1,
    "foremanId": 3001
  }
}

// 后端逻辑
UPDATE orders 
SET status='in_progress', foreman_id=3001, started_at=NOW() 
WHERE id=1;
```

---

## 🎯 简化后的优势

### 1. **开发效率提升**
- ❌ 删除了整个 `projects` 模块（7个文件）
- ✅ 减少 API 接口数量
- ✅ 减少状态同步逻辑

### 2. **数据一致性增强**
- ❌ 无需维护 Order ↔ Project 的状态同步
- ✅ 订单状态即是施工状态，单一数据源

### 3. **业务理解更容易**
- ❌ 订单和项目的职责区分不清
- ✅ 订单 = 从签约到完工的完整生命周期

### 4. **查询性能提升**
- ❌ 需要联表查询：Order JOIN Project
- ✅ 直接查询 Order 表即可

---

## 🔧 迁移指南（如果有现有数据）

如果数据库中已有 `projects` 表的数据，需要执行以下迁移：

```sql
-- 1. 将项目的工长、开工时间、完工时间迁移到订单表
UPDATE orders o
JOIN projects p ON o.id = p.order_id
SET 
  o.foreman_id = p.foreman_id,
  o.started_at = CASE WHEN p.status = 'in_progress' THEN p.created_at END,
  o.completed_at = CASE WHEN p.status = 'completed' THEN p.updated_at END;

-- 2. 同步订单状态（如果项目状态与订单状态不一致）
UPDATE orders o
JOIN projects p ON o.id = p.order_id
SET o.status = CASE 
  WHEN p.status = 'in_progress' THEN 'in_progress'
  WHEN p.status = 'completed' THEN 'completed'
  ELSE o.status
END;

-- 3. 备份项目表（可选）
RENAME TABLE projects TO projects_backup_20251031;

-- 4. 或直接删除项目表
-- DROP TABLE projects;
```

---

## ✅ 验收清单

- [x] 删除 `src/entities/project.entity.ts`
- [x] 删除 `src/modules/projects/` 整个目录
- [x] 清理 `src/entities/index.ts` 中的 Project 导出
- [x] 清理 `src/modules/code/code.module.ts` 中的 Project 引用
- [x] 清理 `src/modules/code/code-executor.service.ts` 中的 projectRepository
- [x] 清理 `src/app.module.ts` 中的 ProjectsModule
- [x] 清理 `src/main.ts` 中的 'projects' Swagger 标签
- [x] 创建简化版业务流程文档
- [x] 代码编译通过（无 linter 错误）

---

## 📌 注意事项

### 1. 数据库迁移
- 如果生产环境已有 `projects` 表，需要执行上述迁移脚本
- 建议先在测试环境验证

### 2. 前端改造（如果有）
- 删除项目相关的页面和组件
- 在订单详情页增加工长、开工时间、完工时间字段
- 订单列表可增加"施工中"筛选项

### 3. API 变更
- 删除所有 `/api/projects/*` 相关接口
- 在 `/api/orders/*` 或 `/api/code/run/order_*` 中补充施工管理功能
  - `order_start` - 订单开工
  - `order_complete` - 订单完工
  - `order_assign_foreman` - 分配工长

---

## 🎉 总结

通过去除冗余的 Project 项目表，我们实现了：

✅ **更简单的数据结构** - Customer → Order → Payment  
✅ **更清晰的业务流程** - 订单承载完整生命周期  
✅ **更高的开发效率** - 减少冗余代码  
✅ **更好的数据一致性** - 单一状态源  
✅ **完全贴合老系统** - 业务流程一致  

符合"**不过度设计，业务闭环，流程精简**"的设计理念！

---

**架构简化日期**: 2025-10-31  
**执行人**: ERP 开发团队  
**审核**: ✅ 通过


