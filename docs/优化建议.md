# erp-core - 优化建议

> **最后更新**: 2025-12-01

## 数据库查询优化

```typescript
// ❌ N+1 查询
const orders = await orderRepo.find();
for (const order of orders) {
  order.customer = await customerRepo.findOne(order.customerId);
}

// ✅ 使用 relations
const orders = await orderRepo.find({
  relations: ['customer', 'materials'],
});

// ✅ 添加索引
@Index(['customerId', 'status'])
@Entity()
export class Order {}
```

---

## Redis 缓存

```typescript
// 缓存字典数据
async getDictByType(type: string) {
  const key = `dict:${type}`;
  let data = await redis.get(key);
  
  if (!data) {
    data = await this.dictRepo.find({ where: { type } });
    await redis.setex(key, 3600, JSON.stringify(data));
  }
  
  return JSON.parse(data);
}
```

**建议缓存**:
- 字典数据 (1小时)
- 用户信息 (30分钟)

---

## API 性能

### 1. 响应压缩

```typescript
// main.ts
import * as compression from 'compression';
app.use(compression());
```

### 2. 分页优化

```typescript
// ✅ 使用 take/skip
const [data, total] = await repo.findAndCount({
  take: 20,
  skip: (page - 1) * 20,
});
```

### 3. 字段选择

```typescript
// ✅ 只查询需要的字段
const users = await repo.find({
  select: ['id', 'name', 'email'],
});
```

---

## 数据库连接池

```typescript
{
  extra: {
    connectionLimit: 10,
    waitForConnections: true,
  },
}
```

---

## API 限流

```typescript
@Module({
  imports: [
    ThrottlerModule.forRoot({
      ttl: 60,
      limit: 100,
    }),
  ],
})
```

---

## 定期维护

```bash
# 分析表
docker exec erp-mysql mysql -u root -p -e \
  "ANALYZE TABLE customer, \`order\`, material;"

# 优化表
docker exec erp-mysql mysql -u root -p -e \
  "OPTIMIZE TABLE \`order\`;"
```

---

## 性能目标

| 指标 | 当前 | 目标 |
|------|------|------|
| API 响应 | 200ms | < 100ms |
| 查询速度 | - | 提升 50% |
| 内存占用 | 150MB | < 120MB |
