# ERP-Core ä¸šåŠ¡æµç¨‹æ–‡æ¡£

> åŸºäºè£…ä¿®è¡Œä¸šçš„å…¨æµç¨‹ ERP ç³»ç»Ÿæ¶æ„ä¸ä¸šåŠ¡é—­ç¯è®¾è®¡

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒå®ä½“å…³ç³»](#æ ¸å¿ƒå®ä½“å…³ç³»)
- [ä¸šåŠ¡æµç¨‹](#ä¸šåŠ¡æµç¨‹)
- [ä¸šåŠ¡é—­ç¯](#ä¸šåŠ¡é—­ç¯)
- [è§’è‰²ä¸æƒé™](#è§’è‰²ä¸æƒé™)
- [æ•°æ®å­—å…¸](#æ•°æ®å­—å…¸)
- [å…³é”®ä¸šåŠ¡è§„åˆ™](#å…³é”®ä¸šåŠ¡è§„åˆ™)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### é¡¹ç›®åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  erp-code                        â”‚  ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆçƒ­æ›´æ–°ï¼‰
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŠ¨æ€ä¸šåŠ¡æµç¨‹ï¼ˆJavaScriptï¼‰              â”‚   â”‚
â”‚  â”‚  - å®¢æˆ·åˆ›å»º/å®¡æ ¸/åˆ†é…                    â”‚   â”‚
â”‚  â”‚  - è®¢å•ç­¾çº¦/å®¡æ‰¹/ç»“ç®—                    â”‚   â”‚
â”‚  â”‚  - é¡¹ç›®è¿›åº¦è·Ÿè¸ª/éªŒæ”¶                     â”‚   â”‚
â”‚  â”‚  - æ”¶æ¬¾ç¡®è®¤/å¯¹è´¦/ç»Ÿè®¡                    â”‚   â”‚
â”‚  â”‚  - ä¸šåŠ¡è§„åˆ™è®¡ç®—/æ•°æ®æ ¡éªŒ                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†• HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  erp-core                        â”‚  åŸºç¡€è®¾æ–½å±‚ï¼ˆç¨³å®šï¼‰
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸºç¡€æœåŠ¡ (NestJS + TypeScript)         â”‚   â”‚
â”‚  â”‚  - æ•°æ®åº“è®¿é—®ï¼ˆTypeORMï¼‰                 â”‚   â”‚
â”‚  â”‚  - èº«ä»½è®¤è¯ï¼ˆJWTï¼‰                       â”‚   â”‚
â”‚  â”‚  - æƒé™æ§åˆ¶ï¼ˆRBACï¼‰                      â”‚   â”‚
â”‚  â”‚  - ä»£ç æ‰§è¡Œå¼•æ“ï¼ˆVM2ï¼‰                   â”‚   â”‚
â”‚  â”‚  - åŸºç¡€ CRUD æ¥å£                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MySQL 8.0 æ•°æ®åº“                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡ç†å¿µ

| å±‚æ¬¡ | æŠ€æœ¯æ ˆ | èŒè´£ | ä¼˜åŠ¿ |
|------|--------|------|------|
| **erp-code** | JavaScript | ä¸šåŠ¡é€»è¾‘ã€ä¸šåŠ¡è§„åˆ™ã€æ•°æ®è½¬æ¢ | çƒ­æ›´æ–°ã€å¿«é€Ÿè¿­ä»£ã€æ— éœ€é‡å¯ |
| **erp-core** | TypeScript + NestJS | æ•°æ®æŒä¹…åŒ–ã€åŸºç¡€ CRUDã€è®¤è¯æˆæƒ | æ€§èƒ½ç¨³å®šã€ç±»å‹å®‰å…¨ã€å¯é  |

---

## ğŸ“Š æ ¸å¿ƒå®ä½“å…³ç³»

### ER å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     User      â”‚
                    â”‚   (ç”¨æˆ·è¡¨)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Customer     â”‚  â”‚CodeFlow    â”‚
            â”‚   (å®¢æˆ·è¡¨)      â”‚  â”‚(ä»£ç æµç¨‹è¡¨) â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
  â”‚CustomerFollowâ”‚   â”‚    â”‚   Order     â”‚
  â”‚ (è·Ÿè¿›è®°å½•è¡¨) â”‚   â”‚    â”‚  (è®¢å•è¡¨)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚           â”‚
                    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    â”‚             â”‚          â”‚         â”‚
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Project   â”‚   â”‚OrderMaterialâ”‚ Payment â”‚ â”‚Material â”‚
                â”‚ (é¡¹ç›®è¡¨)   â”‚   â”‚(è®¢å•ç‰©æ–™è¡¨)â”‚ (æ”¶æ¬¾è¡¨)â”‚ â”‚(ç‰©æ–™åº“) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ä½“æ¸…å•

| å®ä½“ | è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|------|---------|
| **User** | `users` | ç”¨æˆ·è¡¨ | `username`, `role`, `mobile` |
| **Customer** | `customers` | å®¢æˆ·ä¿¡æ¯ | `name`, `mobile`, `status`, `salesId` |
| **CustomerFollow** | `customer_follows` | å®¢æˆ·è·Ÿè¿›è®°å½• | `customerId`, `type`, `content` |
| **Order** | `orders` | è®¢å•ä¸»è¡¨ | `orderNo`, `customerId`, `totalAmount`, `status` |
| **OrderMaterial** | `order_materials` | è®¢å•ç‰©æ–™æ˜ç»† | `orderId`, `materialId`, `quantity`, `amount` |
| **Material** | `materials` | ç‰©æ–™åº“ | `code`, `name`, `category`, `costPrice`, `salePrice` |
| **Payment** | `payments` | æ”¶æ¬¾è®°å½• | `paymentNo`, `orderId`, `type`, `amount`, `status` |
| **Project** | `projects` | æ–½å·¥é¡¹ç›® | `projectNo`, `orderId`, `customerId`, `status` |
| **CodeFlow** | `code_flows` | åŠ¨æ€ä»£ç æµç¨‹ | `key`, `name`, `code`, `category` |

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### 1ï¸âƒ£ å®¢æˆ·è·å–ä¸åŸ¹è‚²æµç¨‹

```mermaid
graph LR
    A[å®¢æˆ·çº¿ç´¢] --> B[é”€å”®è·Ÿè¿›]
    B --> C[ä¸Šé—¨é‡æˆ¿]
    C --> D[æ–¹æ¡ˆæŠ¥ä»·]
    D --> E{æ˜¯å¦ç­¾çº¦}
    E -->|æ˜¯| F[å·²ç­¾çº¦]
    E -->|å¦| B
```

#### çŠ¶æ€æµè½¬

```
leadï¼ˆçº¿ç´¢ï¼‰â†’ measuredï¼ˆå·²é‡æˆ¿ï¼‰â†’ quotedï¼ˆå·²æŠ¥ä»·ï¼‰â†’ signedï¼ˆå·²ç­¾çº¦ï¼‰â†’ completedï¼ˆå·²å®Œå·¥ï¼‰
```

#### å…³é”®èŠ‚ç‚¹

| é˜¶æ®µ | æ“ä½œ | æ•°æ® | è´£ä»»äºº |
|------|------|------|--------|
| **çº¿ç´¢è·å–** | åˆ›å»ºå®¢æˆ· | åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€ç”µè¯ã€åœ°å€ï¼‰ | é”€å”® |
| **ç”µè¯è·Ÿè¿›** | è®°å½•è·Ÿè¿› | è·Ÿè¿›ç±»å‹ï¼š`call` | é”€å”® |
| **ä¸Šé—¨é‡æˆ¿** | è®°å½•è·Ÿè¿› + æ›´æ–°çŠ¶æ€ | è·Ÿè¿›ç±»å‹ï¼š`measure`ï¼ŒçŠ¶æ€â†’`measured` | é”€å”®/è®¾è®¡å¸ˆ |
| **æ–¹æ¡ˆæŠ¥ä»·** | åˆ›å»ºè®¢å•è‰ç¨¿ | è®¢å•æ˜ç»†ï¼ˆä¸»æ+äººå·¥ï¼‰ï¼ŒçŠ¶æ€â†’`quoted` | è®¾è®¡å¸ˆ |
| **ç­¾çº¦ç¡®è®¤** | è®¢å•ç­¾çº¦ | è®¢å•çŠ¶æ€â†’`signed`ï¼Œè®°å½•ç­¾çº¦æ—¶é—´ | é”€å”® |

---

### 2ï¸âƒ£ è®¢å•ç®¡ç†æµç¨‹

```mermaid
graph TD
    A[åˆ›å»ºè®¢å•è‰ç¨¿] --> B[ç¼–è¾‘è®¢å•æ˜ç»†]
    B --> C[è®¡ç®—è®¢å•é‡‘é¢]
    C --> D{å®¢æˆ·ç¡®è®¤}
    D -->|ç¡®è®¤| E[è®¢å•ç­¾çº¦]
    D -->|ä¿®æ”¹| B
    E --> F[åˆ›å»ºæ”¶æ¬¾è®¡åˆ’]
    F --> G[åˆ›å»ºæ–½å·¥é¡¹ç›®]
```

#### è®¢å•çŠ¶æ€æµè½¬

```
draftï¼ˆè‰ç¨¿ï¼‰â†’ signedï¼ˆå·²ç­¾çº¦ï¼‰â†’ in_progressï¼ˆæ–½å·¥ä¸­ï¼‰â†’ completedï¼ˆå·²å®Œå·¥ï¼‰/ cancelledï¼ˆå·²å–æ¶ˆï¼‰
```

#### è®¢å•æ„æˆ

| ç»„æˆéƒ¨åˆ† | è¯´æ˜ | æ•°æ®æ¥æº |
|---------|------|---------|
| **å®¢æˆ·ä¿¡æ¯** | å…³è”å®¢æˆ·ID | `customers` è¡¨ |
| **è®¢å•æ˜ç»†** | ä¸»æã€äººå·¥ã€å¢é¡¹ | `order_materials` è¡¨ |
| **é‡‘é¢è®¡ç®—** | æ€»é‡‘é¢ã€å·²æ”¶é‡‘é¢ã€æˆæœ¬é‡‘é¢ | æ˜ç»†æ±‡æ€» + æ”¶æ¬¾ç»Ÿè®¡ |
| **è´Ÿè´£äºº** | é”€å”®ã€è®¾è®¡å¸ˆã€å·¥é•¿ | `users` è¡¨ |

#### è®¢å•æ˜ç»†åˆ†ç±»

```typescript
export enum OrderItemCategory {
  MAIN = 'main',      // ä¸»æï¼šç“·ç –ã€åœ°æ¿ã€æ©±æŸœç­‰
  LABOR = 'labor',    // äººå·¥ï¼šæ°´ç”µå·¥ã€æ³¥å·¥ã€æœ¨å·¥ç­‰
  ADDITION = 'addition' // å¢é¡¹ï¼šè¿½åŠ é¡¹ç›®
}
```

---

### 3ï¸âƒ£ æ”¶æ¬¾ç®¡ç†æµç¨‹

```mermaid
graph LR
    A[è®¢å•ç­¾çº¦] --> B[åˆ›å»ºæ”¶æ¬¾è®¡åˆ’]
    B --> C[å®¢æˆ·æ”¯ä»˜]
    C --> D[è´¢åŠ¡ç¡®è®¤]
    D --> E[æ›´æ–°è®¢å•å·²æ”¶é‡‘é¢]
```

#### æ”¶æ¬¾ç±»å‹

| ç±»å‹ | è¯´æ˜ | å æ¯”å‚è€ƒ | æ—¶é—´èŠ‚ç‚¹ |
|------|------|----------|---------|
| **å®šé‡‘** | `deposit` | 10-20% | ç­¾çº¦æ—¶ |
| **åˆåŒæ¬¾** | `contract` | 60-70% | å¼€å·¥å‰ |
| **è®¾è®¡è´¹** | `design_fee` | å›ºå®šé‡‘é¢ | æ–¹æ¡ˆç¡®è®¤å |
| **å¢é¡¹æ¬¾** | `addition` | æŒ‰å®é™… | å¢é¡¹ç¡®è®¤å |

#### æ”¶æ¬¾çŠ¶æ€æµè½¬

```
pendingï¼ˆå¾…ç¡®è®¤ï¼‰â†’ confirmedï¼ˆå·²ç¡®è®¤ï¼‰/ cancelledï¼ˆå·²å–æ¶ˆï¼‰
```

---

### 4ï¸âƒ£ é¡¹ç›®æ–½å·¥æµç¨‹

```mermaid
graph TD
    A[è®¢å•ç­¾çº¦] --> B[åˆ›å»ºæ–½å·¥é¡¹ç›®]
    B --> C[åˆ†é…å·¥é•¿]
    C --> D[é¡¹ç›®å¼€å·¥]
    D --> E[æ–½å·¥è¿›åº¦è·Ÿè¸ª]
    E --> F[é¡¹ç›®éªŒæ”¶]
    F --> G[é¡¹ç›®å®Œå·¥]
```

#### é¡¹ç›®çŠ¶æ€æµè½¬

```
planningï¼ˆè§„åˆ’ä¸­ï¼‰â†’ in_progressï¼ˆæ–½å·¥ä¸­ï¼‰â†’ pausedï¼ˆæš‚åœï¼‰/ completedï¼ˆå·²å®Œå·¥ï¼‰
```

#### å…³é”®è§’è‰²

| è§’è‰² | èŒè´£ | æ“ä½œæƒé™ |
|------|------|---------|
| **é”€å”®** | å®¢æˆ·ç»´æŠ¤ã€è®¢å•ç­¾çº¦ | åˆ›å»ºå®¢æˆ·ã€è®¢å• |
| **è®¾è®¡å¸ˆ** | æ–¹æ¡ˆè®¾è®¡ã€æŠ¥ä»· | ç¼–è¾‘è®¢å•æ˜ç»† |
| **å·¥é•¿** | é¡¹ç›®æ–½å·¥ã€è¿›åº¦ç®¡ç† | æ›´æ–°é¡¹ç›®çŠ¶æ€ |
| **è´¢åŠ¡** | æ”¶æ¬¾ç¡®è®¤ã€å¯¹è´¦ | ç¡®è®¤æ”¶æ¬¾ |
| **ç®¡ç†å‘˜** | ç³»ç»Ÿç®¡ç†ã€å®¡æ‰¹ | å…¨éƒ¨æƒé™ |

---

## ğŸ” ä¸šåŠ¡é—­ç¯

### å®Œæ•´ä¸šåŠ¡é—­ç¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è£…ä¿®ä¸šåŠ¡å…¨æµç¨‹é—­ç¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ ã€å®¢æˆ·è·å–ã€‘
   â†“
   çº¿ç´¢å½•å…¥ â†’ é”€å”®åˆ†é… â†’ ç”µè¯è·Ÿè¿›
   â”‚
   â”œâ”€ å®¢æˆ·ä¿¡æ¯ï¼šå§“åã€ç”µè¯ã€åœ°å€ã€æ¥æº
   â”œâ”€ è·Ÿè¿›è®°å½•ï¼šæ²Ÿé€šå†…å®¹ã€ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´
   â””â”€ çŠ¶æ€ï¼šleadï¼ˆçº¿ç´¢ï¼‰

2ï¸âƒ£ ã€éœ€æ±‚ç¡®è®¤ã€‘
   â†“
   ä¸Šé—¨é‡æˆ¿ â†’ æ–¹æ¡ˆè®¾è®¡ â†’ æŠ¥ä»·ç¡®è®¤
   â”‚
   â”œâ”€ å®¢æˆ·çŠ¶æ€ï¼šmeasuredï¼ˆå·²é‡æˆ¿ï¼‰â†’ quotedï¼ˆå·²æŠ¥ä»·ï¼‰
   â”œâ”€ è®¢å•è‰ç¨¿ï¼šä¸»ææ¸…å•ã€äººå·¥è´¹ç”¨
   â””â”€ è®¢å•é‡‘é¢ï¼šsum(æ˜ç»†é‡‘é¢)

3ï¸âƒ£ ã€åˆåŒç­¾çº¦ã€‘
   â†“
   å®¢æˆ·ç­¾çº¦ â†’ åˆ›å»ºæ­£å¼è®¢å• â†’ åˆ¶å®šæ”¶æ¬¾è®¡åˆ’
   â”‚
   â”œâ”€ è®¢å•çŠ¶æ€ï¼šdraft â†’ signed
   â”œâ”€ å®¢æˆ·çŠ¶æ€ï¼šsignedï¼ˆå·²ç­¾çº¦ï¼‰
   â”œâ”€ æ”¶æ¬¾è®¡åˆ’ï¼šå®šé‡‘ã€åˆåŒæ¬¾ã€å°¾æ¬¾
   â””â”€ ç­¾çº¦æ—¶é—´ï¼šsignedAt

4ï¸âƒ£ ã€é¡¹ç›®æ‰§è¡Œã€‘
   â†“
   å®šé‡‘åˆ°è´¦ â†’ åˆ›å»ºé¡¹ç›® â†’ åˆ†é…å·¥é•¿ â†’ é¡¹ç›®å¼€å·¥
   â”‚
   â”œâ”€ é¡¹ç›®åˆ›å»ºï¼šè‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ç¼–å·
   â”œâ”€ å·¥é•¿åˆ†é…ï¼šforemanId
   â”œâ”€ é¡¹ç›®çŠ¶æ€ï¼šplanning â†’ in_progress
   â””â”€ è®¢å•çŠ¶æ€ï¼šsigned â†’ in_progress

5ï¸âƒ£ ã€æ–½å·¥ç®¡ç†ã€‘
   â†“
   æ–½å·¥è¿›åº¦è·Ÿè¸ª â†’ å¢é¡¹ç®¡ç† â†’ è´¨é‡éªŒæ”¶
   â”‚
   â”œâ”€ è¿›åº¦æ›´æ–°ï¼šé¡¹ç›®çŠ¶æ€å®æ—¶åŒæ­¥
   â”œâ”€ å¢é¡¹å¤„ç†ï¼šè¿½åŠ è®¢å•æ˜ç»† â†’ å¢åŠ è®¢å•é‡‘é¢
   â””â”€ éªŒæ”¶ç¡®è®¤ï¼šé¡¹ç›®çŠ¶æ€ â†’ completed

6ï¸âƒ£ ã€æ”¶æ¬¾ç»“ç®—ã€‘
   â†“
   åˆ†æœŸæ”¶æ¬¾ â†’ è´¢åŠ¡ç¡®è®¤ â†’ æ›´æ–°è®¢å•å·²æ”¶é‡‘é¢
   â”‚
   â”œâ”€ æ”¶æ¬¾è®°å½•ï¼špaymentNo, type, amount
   â”œâ”€ çŠ¶æ€æµè½¬ï¼špending â†’ confirmed
   â””â”€ è®¢å•æ›´æ–°ï¼špaidAmount += amount

7ï¸âƒ£ ã€é¡¹ç›®äº¤ä»˜ã€‘
   â†“
   å·¥ç¨‹éªŒæ”¶ â†’ å°¾æ¬¾ç»“æ¸… â†’ é¡¹ç›®å®Œå·¥ â†’ å®¢æˆ·å›è®¿
   â”‚
   â”œâ”€ é¡¹ç›®çŠ¶æ€ï¼šcompleted
   â”œâ”€ è®¢å•çŠ¶æ€ï¼šcompleted
   â”œâ”€ å®¢æˆ·çŠ¶æ€ï¼šcompleted
   â””â”€ å®Œå·¥æ—¶é—´ï¼šcompletedAt

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      âœ… ä¸šåŠ¡é—­ç¯å®Œæˆ                            â”‚
â”‚  å®¢æˆ·æ•°æ® â†’ è®¢å•æ•°æ® â†’ é¡¹ç›®æ•°æ® â†’ æ”¶æ¬¾æ•°æ® â†’ å…¨éƒ¨å½’æ¡£          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ•°æ®æµè½¬

| é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | è§¦å‘æ¡ä»¶ |
|------|------|------|---------|
| çº¿ç´¢â†’é‡æˆ¿ | å®¢æˆ·åŸºæœ¬ä¿¡æ¯ | é‡æˆ¿è·Ÿè¿›è®°å½• | é”€å”®é¢„çº¦ |
| é‡æˆ¿â†’æŠ¥ä»· | é‡æˆ¿æ•°æ® | è®¢å•è‰ç¨¿ï¼ˆæ˜ç»†+é‡‘é¢ï¼‰ | è®¾è®¡å¸ˆå‡ºæ–¹æ¡ˆ |
| æŠ¥ä»·â†’ç­¾çº¦ | è®¢å•è‰ç¨¿ | æ­£å¼è®¢å• | å®¢æˆ·ç­¾å­— |
| ç­¾çº¦â†’å¼€å·¥ | æ­£å¼è®¢å• + å®šé‡‘ | æ–½å·¥é¡¹ç›® | å®šé‡‘åˆ°è´¦ |
| å¼€å·¥â†’å®Œå·¥ | é¡¹ç›®è¿›åº¦ | å®Œå·¥éªŒæ”¶ | å·¥é•¿ç¡®è®¤ |
| æ”¶æ¬¾â†’å¯¹è´¦ | æ”¶æ¬¾è®°å½• | è®¢å•å·²æ”¶é‡‘é¢ | è´¢åŠ¡ç¡®è®¤ |

---

## ğŸ‘¥ è§’è‰²ä¸æƒé™

### è§’è‰²å®šä¹‰

```typescript
export enum UserRole {
  ADMIN = 'admin',        // ç³»ç»Ÿç®¡ç†å‘˜
  SALES = 'sales',        // é”€å”®
  DESIGNER = 'designer',  // è®¾è®¡å¸ˆ
  FOREMAN = 'foreman',    // å·¥é•¿
  FINANCE = 'finance',    // è´¢åŠ¡
}
```

### æƒé™çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | ç®¡ç†å‘˜ | é”€å”® | è®¾è®¡å¸ˆ | å·¥é•¿ | è´¢åŠ¡ |
|---------|-------|------|--------|------|------|
| **å®¢æˆ·ç®¡ç†** | âœ… | âœ… | âŒ | âŒ | âŒ |
| åˆ›å»ºå®¢æˆ· | âœ… | âœ… | âŒ | âŒ | âŒ |
| åˆ†é…å®¢æˆ· | âœ… | âœ… | âŒ | âŒ | âŒ |
| å®¢æˆ·è·Ÿè¿› | âœ… | âœ… | âœ… | âŒ | âŒ |
| **è®¢å•ç®¡ç†** | âœ… | âœ… | âœ… | âŒ | âŒ |
| åˆ›å»ºè®¢å• | âœ… | âœ… | âœ… | âŒ | âŒ |
| ç¼–è¾‘æ˜ç»† | âœ… | âœ… | âœ… | âŒ | âŒ |
| è®¢å•ç­¾çº¦ | âœ… | âœ… | âŒ | âŒ | âŒ |
| **é¡¹ç›®ç®¡ç†** | âœ… | âŒ | âŒ | âœ… | âŒ |
| åˆ›å»ºé¡¹ç›® | âœ… | âœ… | âŒ | âŒ | âŒ |
| æ›´æ–°è¿›åº¦ | âœ… | âŒ | âŒ | âœ… | âŒ |
| é¡¹ç›®å®Œå·¥ | âœ… | âŒ | âŒ | âœ… | âŒ |
| **æ”¶æ¬¾ç®¡ç†** | âœ… | âŒ | âŒ | âŒ | âœ… |
| åˆ›å»ºæ”¶æ¬¾ | âœ… | âŒ | âŒ | âŒ | âœ… |
| ç¡®è®¤æ”¶æ¬¾ | âœ… | âŒ | âŒ | âŒ | âœ… |
| **ç³»ç»Ÿç®¡ç†** | âœ… | âŒ | âŒ | âŒ | âŒ |
| ç”¨æˆ·ç®¡ç† | âœ… | âŒ | âŒ | âŒ | âŒ |
| ä»£ç æµç¨‹ç®¡ç† | âœ… | âŒ | âŒ | âŒ | âŒ |

---

## ğŸ“š æ•°æ®å­—å…¸

### å®¢æˆ·æ¥æºï¼ˆcustomer_sourceï¼‰

| å€¼ | æ ‡ç­¾ | è¯´æ˜ |
|-------|--------|------|
| `online` | çº¿ä¸Šæ¨å¹¿ | ç½‘ç»œå¹¿å‘Šã€SEOã€SEM |
| `offline` | çº¿ä¸‹æ´»åŠ¨ | å±•ä¼šã€åœ°æ¨ã€ä¼ å• |
| `referral` | å®¢æˆ·è½¬ä»‹ç» | è€å®¢æˆ·æ¨è |
| `other` | å…¶ä»–æ¸ é“ | å…¶ä»–æ¥æº |

### æ”¶æ¬¾æ–¹å¼ï¼ˆpayment_methodï¼‰

| å€¼ | æ ‡ç­¾ | è¯´æ˜ |
|-------|--------|------|
| `cash` | ç°é‡‘ | ç°é‡‘æ”¯ä»˜ |
| `bank_transfer` | é“¶è¡Œè½¬è´¦ | å¯¹å…¬/å¯¹ç§è½¬è´¦ |
| `alipay` | æ”¯ä»˜å® | æ”¯ä»˜å®æ”¯ä»˜ |
| `wechat` | å¾®ä¿¡æ”¯ä»˜ | å¾®ä¿¡æ”¯ä»˜ |

### ç‰©æ–™å•ä½ï¼ˆmaterial_unitï¼‰

| å€¼ | æ ‡ç­¾ | è¯´æ˜ |
|-------|--------|------|
| `piece` | ä¸ª | æŒ‰ä¸ªè®¡æ•° |
| `meter` | ç±³ | é•¿åº¦å•ä½ |
| `square_meter` | å¹³æ–¹ç±³ | é¢ç§¯å•ä½ |
| `box` | ç›’ | æŒ‰ç›’è®¡æ•° |
| `set` | å¥— | æŒ‰å¥—è®¡æ•° |

---

## ğŸ” å…³é”®ä¸šåŠ¡è§„åˆ™

### 1. å®¢æˆ·ç®¡ç†è§„åˆ™

```javascript
// å®¢æˆ·çŠ¶æ€åªèƒ½å•å‘æµè½¬ï¼Œä¸èƒ½å›é€€
lead â†’ measured â†’ quoted â†’ signed â†’ completed

// å®¢æˆ·å¿…é¡»æœ‰è´Ÿè´£é”€å”®
customer.salesId !== null

// ç­¾çº¦å®¢æˆ·å¿…é¡»æœ‰è®¾è®¡å¸ˆ
if (customer.status === 'signed') {
  customer.designerId !== null
}
```

### 2. è®¢å•ç®¡ç†è§„åˆ™

```javascript
// è®¢å•ç¼–å·è‡ªåŠ¨ç”Ÿæˆ
orderNo = 'ORD' + YYYYMMDD + åºå·ï¼ˆ4ä½ï¼‰
// ç¤ºä¾‹ï¼šORD202510300001

// è®¢å•æ€»é‡‘é¢ = æ‰€æœ‰è®¢å•æ˜ç»†é‡‘é¢ä¹‹å’Œ
order.totalAmount = sum(orderMaterials.amount)

// è®¢å•æ˜ç»†é‡‘é¢ = æ•°é‡ Ã— å•ä»·
orderMaterial.amount = quantity Ã— price

// è®¢å•å¯æ”¶é‡‘é¢æ ¡éªŒ
order.paidAmount <= order.totalAmount
```

### 3. é¡¹ç›®ç®¡ç†è§„åˆ™

```javascript
// é¡¹ç›®ç¼–å·è‡ªåŠ¨ç”Ÿæˆ
projectNo = 'PRJ' + YYYYMMDD + åºå·ï¼ˆ4ä½ï¼‰
// ç¤ºä¾‹ï¼šPRJ202510300001

// ä¸€ä¸ªè®¢å•å¯ä»¥æœ‰å¤šä¸ªé¡¹ç›®ï¼ˆæ‹†åˆ†æ–½å·¥ï¼‰
order.projects.length >= 1

// é¡¹ç›®å¿…é¡»å…³è”è®¢å•å’Œå®¢æˆ·
project.orderId !== null && project.customerId !== null

// é¡¹ç›®å¿…é¡»æœ‰å·¥é•¿
if (project.status === 'in_progress') {
  project.foremanId !== null
}
```

### 4. æ”¶æ¬¾ç®¡ç†è§„åˆ™

```javascript
// æ”¶æ¬¾å•å·è‡ªåŠ¨ç”Ÿæˆ
paymentNo = 'PAY' + YYYYMMDD + åºå·ï¼ˆ4ä½ï¼‰
// ç¤ºä¾‹ï¼šPAY202510300001

// æ”¶æ¬¾é‡‘é¢å¿…é¡»å¤§äº0
payment.amount > 0

// è®¢å•å·²æ”¶é‡‘é¢ = æ‰€æœ‰å·²ç¡®è®¤æ”¶æ¬¾ä¹‹å’Œ
order.paidAmount = sum(payments.amount where status='confirmed')

// æ”¶æ¬¾ä¸èƒ½è¶…è¿‡è®¢å•æ€»é¢
order.paidAmount <= order.totalAmount
```

### 5. ç‰©æ–™ç®¡ç†è§„åˆ™

```javascript
// ç‰©æ–™ç¼–ç è‡ªåŠ¨ç”Ÿæˆ
code = 'MAT' + YYYYMMDD + åºå·ï¼ˆ4ä½ï¼‰
// ç¤ºä¾‹ï¼šMAT202510300001

// é”€å”®ä»·å¿…é¡»å¤§äºç­‰äºæˆæœ¬ä»·ï¼ˆå¯é…ç½®ä¾‹å¤–ï¼‰
material.salePrice >= material.costPrice

// è®¢å•æ˜ç»†å¯ä»¥å…³è”ç‰©æ–™åº“ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰
orderMaterial.materialId // å¯é€‰
orderMaterial.materialName // å¿…å¡«
```

---

## ğŸš€ ä»£ç æµç¨‹è®¾è®¡

### erp-code é¡¹ç›®ä¸­çš„ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

```javascript
/**
 * @flowKey customer_create
 * @flowName å®¢æˆ·åˆ›å»º
 * @description åˆ›å»ºæ–°å®¢æˆ·å¹¶åˆ†é…ç»™å½“å‰é”€å”®
 */
const { repositories, params, user } = context;
const { customerRepository } = repositories;

// å‚æ•°æ ¡éªŒ
if (!params.name || !params.mobile) {
  throw new Error('å®¢æˆ·å§“åå’Œæ‰‹æœºå·ä¸èƒ½ä¸ºç©º');
}

// æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
const existing = await customerRepository.findOne({
  where: { mobile: params.mobile }
});
if (existing) {
  throw new Error('è¯¥æ‰‹æœºå·å·²è¢«æ³¨å†Œ');
}

// åˆ›å»ºå®¢æˆ·
const customer = customerRepository.create({
  ...params,
  salesId: user.id, // è‡ªåŠ¨åˆ†é…ç»™å½“å‰é”€å”®
  status: 'lead',   // åˆå§‹çŠ¶æ€ä¸ºçº¿ç´¢
});

await customerRepository.save(customer);

return {
  success: true,
  data: customer,
  message: 'å®¢æˆ·åˆ›å»ºæˆåŠŸ',
};
```

### æµç¨‹è°ƒç”¨ç¤ºä¾‹

```bash
POST /api/code/run/customer_create
Authorization: Bearer <token>

{
  "params": {
    "name": "å¼ ä¸‰",
    "mobile": "13800138000",
    "address": "åŒ—äº¬å¸‚æœé˜³åŒºæŸæŸå°åŒº",
    "area": "æœé˜³åŒº"
  }
}
```

---

## ğŸ“ˆ æ•°æ®ç»Ÿè®¡ç»´åº¦

### å®¢æˆ·ç»Ÿè®¡

- å®¢æˆ·æ¥æºåˆ†å¸ƒ
- å®¢æˆ·çŠ¶æ€åˆ†å¸ƒ
- é”€å”®å®¢æˆ·æ•°æ’å
- å®¢æˆ·è½¬åŒ–ç‡ï¼ˆç­¾çº¦/æ€»æ•°ï¼‰

### è®¢å•ç»Ÿè®¡

- è®¢å•é‡‘é¢ç»Ÿè®¡ï¼ˆæ—¥/æœˆ/å¹´ï¼‰
- è®¢å•çŠ¶æ€åˆ†å¸ƒ
- é”€å”®ä¸šç»©æ’å
- å®¢å•ä»·åˆ†æ

### é¡¹ç›®ç»Ÿè®¡

- åœ¨æ–½é¡¹ç›®æ•°
- é¡¹ç›®å®Œå·¥ç‡
- å·¥é•¿é¡¹ç›®æ•°æ’å
- é¡¹ç›®å‘¨æœŸåˆ†æ

### æ”¶æ¬¾ç»Ÿè®¡

- æ”¶æ¬¾é‡‘é¢ç»Ÿè®¡ï¼ˆæ—¥/æœˆ/å¹´ï¼‰
- æ”¶æ¬¾æ–¹å¼åˆ†å¸ƒ
- åº”æ”¶è´¦æ¬¾ç»Ÿè®¡
- å›æ¬¾ç‡åˆ†æ

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. æ•°æ®ä¸€è‡´æ€§

```typescript
// ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
const queryRunner = dataSource.createQueryRunner();
await queryRunner.startTransaction();

try {
  // 1. æ›´æ–°è®¢å•çŠ¶æ€
  await queryRunner.manager.update(Order, orderId, { status: 'signed' });
  
  // 2. æ›´æ–°å®¢æˆ·çŠ¶æ€
  await queryRunner.manager.update(Customer, customerId, { status: 'signed' });
  
  // 3. åˆ›å»ºæ”¶æ¬¾è®¡åˆ’
  await queryRunner.manager.save(Payment, paymentPlan);
  
  await queryRunner.commitTransaction();
} catch (err) {
  await queryRunner.rollbackTransaction();
  throw err;
}
```

### 2. æƒé™æ§åˆ¶

```typescript
// ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œæƒé™æ§åˆ¶
@UseGuards(RolesGuard)
@Roles(UserRole.SALES, UserRole.ADMIN)
@Post('customers')
async createCustomer(@Body() dto: CreateCustomerDto) {
  // ...
}
```

### 3. åŠ¨æ€ä»£ç æ‰§è¡Œ

```typescript
// erp-core æä¾›ä»£ç æ‰§è¡Œå¼•æ“
POST /api/code/run/:flowKey

// erp-code ä¸Šä¼ ä¸šåŠ¡ä»£ç 
POST /api/code/upload
Headers: x-access-secret: <å¯†é’¥>
```

---

## ğŸ“ æ€»ç»“

æœ¬ç³»ç»Ÿé€šè¿‡ **erp-coreï¼ˆåŸºç¡€è®¾æ–½ï¼‰+ erp-codeï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰** çš„åˆ†å±‚æ¶æ„ï¼Œå®ç°äº†ï¼š

âœ… **å®Œæ•´çš„ä¸šåŠ¡é—­ç¯**ï¼šä»å®¢æˆ·è·å–â†’è®¢å•ç­¾çº¦â†’é¡¹ç›®æ–½å·¥â†’æ”¶æ¬¾ç»“ç®—â†’é¡¹ç›®äº¤ä»˜  
âœ… **çµæ´»çš„æƒé™ä½“ç³»**ï¼šåŸºäºè§’è‰²çš„ç²¾ç»†åŒ–æƒé™æ§åˆ¶  
âœ… **ç¨³å®šçš„æ•°æ®ç»“æ„**ï¼šè§„èŒƒåŒ–çš„æ•°æ®åº“è®¾è®¡ï¼Œæ”¯æŒå¤æ‚ä¸šåŠ¡åœºæ™¯  
âœ… **åŠ¨æ€çš„ä¸šåŠ¡é€»è¾‘**ï¼šçƒ­æ›´æ–°ä»£ç ï¼Œæ— éœ€é‡å¯æœåŠ¡  
âœ… **æ¸…æ™°çš„èŒè´£åˆ†å·¥**ï¼šä¸åŒè§’è‰²å„å¸å…¶èŒï¼ŒååŒå®Œæˆä¸šåŠ¡æµç¨‹  

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-30  
**ç»´æŠ¤äººå‘˜**: ERP å¼€å‘å›¢é˜Ÿ

