# ERP Core 数据库表关系图

## 核心表结构（16张表）

```mermaid
erDiagram
    %% 组织架构
    companies ||--o{ departments : "拥有部门"
    companies ||--o{ users : "员工"
    departments ||--o{ users : "员工"
    
    %% 权限管理
    menus ||--o{ role_menus : "角色关联"
    
    %% 用户相关
    users ||--o{ customer_follows : "创建跟进"
    users ||--o{ orders : "负责销售"
    users ||--o{ payments : "创建收款"
    users ||--o{ logs : "操作日志"
    users ||--o{ code_flows : "创建流程"
    
    %% 客户相关
    customers ||--o{ customer_follows : "跟进记录"
    customers ||--o{ orders : "下单"
    customers ||--o{ projects : "项目"
    
    %% 订单相关
    orders ||--o{ order_materials : "包含明细"
    orders ||--o{ payments : "收款"
    orders ||--o{ projects : "关联项目"
    
    %% 材料相关
    materials ||--o{ order_materials : "使用"

    %% ==================== 公司表 ====================
    companies {
        int id PK
        string name "公司名称"
        string contact "联系人"
        string phone "联系电话"
        string address "公司地址"
        int status "状态: 1-正常 0-停用"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 部门表 ====================
    departments {
        int id PK
        string name "部门名称"
        int company_id FK "所属公司ID"
        int parent_id "上级部门ID"
        string leader "部门负责人"
        string phone "联系电话"
        int sort "排序序号"
        int status "状态: 1-正常 0-停用"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 用户表 ====================
    users {
        int id PK
        string username UK "用户名(唯一)"
        string name "姓名"
        string password "密码(已加密)"
        string mobile UK "手机号(唯一)"
        string email "邮箱地址"
        text avatar "头像URL"
        enum role "角色: admin, sales, designer, foreman, finance"
        int status "状态: 1-正常 0-禁用 2-锁定"
        int company_id FK "公司ID"
        int department_id FK "部门ID"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 菜单表 ====================
    menus {
        int id PK
        string name "菜单名称"
        string title "菜单标题"
        string icon "菜单图标"
        string path "路由路径"
        string component "组件路径"
        int parent_id "上级菜单ID"
        string type "类型: menu-菜单, button-按钮"
        string permission "权限标识"
        int sort "排序序号"
        int hidden "是否隐藏: 1-隐藏 0-显示"
        int status "状态: 1-启用 0-禁用"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 角色菜单关联表 ====================
    role_menus {
        int id PK
        string role "角色标识"
        int menu_id FK "菜单ID"
        datetime created_at
        datetime updated_at
    }

    %% ==================== 客户表 ====================
    customers {
        int id PK
        string name "客户姓名"
        string mobile "手机号"
        text address "地址"
        string area "区域"
        enum status "状态: lead, measured, quoted, signed, completed"
        int sales_id FK "销售ID"
        int designer_id FK "设计师ID"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 客户跟进表 ====================
    customer_follows {
        int id PK
        int customer_id FK
        int user_id FK
        enum type "跟进类型: call, visit, measure, quote"
        text content "跟进内容"
        datetime follow_at "跟进时间"
        datetime created_at
        datetime updated_at
    }

    %% ==================== 材料表 ====================
    materials {
        int id PK
        string code UK "材料编码(唯一)"
        string name "材料名称"
        enum category "类别: main(主材), labor(人工)"
        string brand "品牌"
        string spec "规格"
        string unit "单位"
        decimal price "单价(元)"
        enum status "状态: active, inactive"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 订单表 ====================
    orders {
        int id PK
        string order_no UK "订单号(唯一)"
        int customer_id FK
        enum status "状态: draft, signed, in_progress, completed, cancelled"
        decimal total_amount "订单总金额(元)"
        decimal paid_amount "已收金额(元)"
        int sales_id FK "销售ID"
        int designer_id FK "设计师ID"
        int foreman_id FK "工长ID"
        datetime signed_at "签约时间"
        datetime started_at "开工时间"
        datetime completed_at "完工时间"
        datetime created_at
        datetime updated_at
    }

    %% ==================== 订单物料明细表 ====================
    order_materials {
        int id PK
        int order_id FK
        int material_id FK
        string material_name "材料名称"
        enum category "类别: main, labor, addition"
        decimal quantity "数量"
        string unit "单位"
        decimal price "单价(元)"
        decimal amount "小计金额(元)"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 收款表 ====================
    payments {
        int id PK
        string payment_no UK "收款单号(唯一)"
        int order_id FK
        enum type "类型: deposit, contract, design_fee, addition"
        decimal amount "收款金额(元)"
        string method "收款方式"
        enum status "状态: pending, confirmed, cancelled"
        datetime paid_at "收款时间"
        int created_by FK
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 项目表 ====================
    projects {
        int id PK
        string project_no UK "项目编号(唯一)"
        int order_id FK
        int customer_id FK
        string name "项目名称"
        text address "施工地址"
        enum status "状态: planning, in_progress, paused, completed"
        int foreman_id FK "工长ID"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 文件表 ====================
    files {
        int id PK
        string filename "文件名"
        string mimetype "MIME类型"
        bigint size "文件大小(字节)"
        text url "文件URL"
        string category "类别"
        string related_type "关联类型"
        int related_id "关联ID"
        int uploaded_by FK
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 字典表 ====================
    dicts {
        int id PK
        string type "字典类型"
        string key "字典键"
        string value "字典值"
        int sort "排序序号"
        int status "状态: 1-启用 0-禁用"
        text remark
        datetime created_at
        datetime updated_at
    }

    %% ==================== 操作日志表 ====================
    logs {
        int id PK
        int user_id FK "操作人ID"
        string username "操作人用户名"
        string module "操作模块"
        string action "操作类型"
        text content "操作详细内容"
        string ip "操作IP地址"
        text user_agent "浏览器信息"
        string method "HTTP方法"
        text path "请求URL路径"
        int duration "请求耗时(毫秒)"
        datetime created_at
        datetime updated_at
    }

    %% ==================== 代码流程表 ====================
    code_flows {
        int id PK
        string code UK "流程编码(唯一)"
        string name "流程名称"
        string category "流程分类"
        text description "流程描述"
        text code_content "流程代码(JavaScript)"
        int status "状态: 1-启用 0-禁用"
        int created_by FK
        int updated_by FK
        text remark
        datetime created_at
        datetime updated_at
    }
```

## 业务流程说明

### 1. 客户管理流程
```
客户录入(lead) → 量房(measured) → 报价(quoted) → 签约(signed) → 完工(completed)
    ↓            ↓                ↓              ↓             ↓
customer_follows 记录每个阶段的跟进情况
```

### 2. 订单流程
```
创建订单(draft) → 签约(signed) → 施工中(in_progress) → 完工(completed)
    ↓               ↓               ↓                    ↓
  报价单         定金/合同款      增项款               尾款
                   (payments表)
```

### 3. 组织架构
```
公司(companies) → 部门(departments) → 用户(users)
                      ↓
                  可设置上级部门，支持树形结构
```

### 4. 权限管理
```
角色(UserRole枚举) → role_menus → menus
                        ↓
                   动态菜单权限分配
```

### 5. 操作审计
```
所有关键操作 → 记录到 logs 表
    ↓
包含：操作人、模块、动作、IP、耗时等
```

## 核心索引

### 唯一索引
- `users.username`
- `users.mobile`
- `materials.code`
- `orders.order_no`
- `payments.payment_no`
- `projects.project_no`
- `code_flows.code`

### 普通索引
- `departments.company_id`
- `users.(company_id, department_id)`
- `menus.(parent_id, sort)`
- `role_menus.(role, menu_id)`
- `customers.(mobile, status, sales_id)`
- `orders.(customer_id, status)`
- `order_materials.(order_id, material_id)`
- `payments.(order_id, status)`
- `projects.(order_id, status)`
- `dicts.(type, status)`
- `logs.(user_id, module, action)`
- `code_flows.(category, status)`

## 新增表说明

### menus - 菜单表
- 支持树形结构（parent_id）
- type 区分菜单和按钮权限
- permission 用于API权限控制

### role_menus - 角色菜单关联表
- 通过 role 字段关联角色
- 实现角色到菜单的多对多关系
- 灵活配置不同角色的菜单权限

### logs - 操作日志表
- 记录所有关键操作
- 用于审计和问题追溯
- 包含完整的请求信息（IP、耗时等）
