# ERP Core 后端架构说明

## 角色定位

erp-core 是 ERP 系统的**后端 API 服务**，提供：
- RESTful API 接口
- 业务逻辑处理
- 数据库操作
- Redis 缓存

## 架构图

```
        ┌─────────────────┐
        │    erp-web      │
        │   (前端服务)     │
        └─────────────────┘
                  │
                  │ /api/* 请求
                  ▼
        ┌─────────────────┐
        │   erp-core      │ ◄── 本服务
        │   (端口 3009)    │
        └─────────────────┘
                  │
       ┌──────────┴──────────┐
       ▼                     ▼
┌─────────────┐       ┌─────────────┐
│  erp-mysql  │       │  erp-redis  │
│  (端口 3306) │       │  (端口 6379) │
└─────────────┘       └─────────────┘
```

## 网络配置

| 网络 | 用途 |
|------|------|
| `erp-db-network` | ERP 共享网络，可访问 MySQL 和 Redis |

本服务暴露 3009 端口，但只在 Docker 网络内部可访问。

## 环境变量

```bash
# 应用配置
NODE_ENV=production
PORT=3009
APP_NAME=ERP-Core

# 数据库配置 (使用容器名称)
DB_TYPE=mysql
DB_HOST=erp-mysql          # 容器名，非 IP
DB_PORT=3306
DB_USERNAME=erp_user
DB_PASSWORD=xxx
DB_DATABASE=erp_core

# Redis 配置 (使用容器名称)
REDIS_HOST=erp-redis       # 容器名，非 IP
REDIS_PORT=6379
REDIS_PASSWORD=xxx

# JWT 配置
JWT_SECRET=xxx
JWT_EXPIRES_IN=7d

# 文件上传
UPLOAD_MAX_SIZE=10485760
UPLOAD_DEST=./uploads
```

## 文件结构

```
erp-core/
├── docker-compose.prod.yml   # 生产环境 Docker 配置
├── Dockerfile                # Docker 构建文件
├── .github/
│   └── workflows/
│       └── deploy.yml        # GitHub Actions 部署
├── src/                      # 源码目录
├── uploads/                  # 文件上传目录 (volume)
├── logs/                     # 日志目录 (volume)
└── ARCHITECTURE.md           # 本文档
```

## 数据持久化

以下目录通过 Docker volume 持久化：

| 目录 | 用途 |
|------|------|
| `./uploads` | 用户上传的文件 |
| `./logs` | 应用日志 |

## 健康检查

```yaml
healthcheck:
  test: ["CMD", "node", "-e", "require('http').get('http://localhost:3009/api')"]
  interval: 30s
  timeout: 3s
```

访问 `/api` 端点检查服务是否正常。

## 部署方式

通过 GitHub Actions 自动部署：

1. 推送代码到 master 分支
2. 构建 Docker 镜像并推送到阿里云 ACR
3. 服务器拉取镜像并重启容器

## GitHub Secrets 配置

| Secret | 说明 |
|--------|------|
| `ACR_REGISTRY` | 阿里云 ACR 地址 |
| `ACR_NAMESPACE` | ACR 命名空间 |
| `ACR_USERNAME` | ACR 用户名 |
| `ACR_PASSWORD` | ACR 密码 |
| `SSH_HOST` | 服务器 IP |
| `SSH_USERNAME` | SSH 用户名 |
| `SSH_PASSWORD` | SSH 密码 |
| `DB_USER_PASSWORD` | 数据库用户密码 |
| `REDIS_PASSWORD` | Redis 密码 |
| `JWT_SECRET` | JWT 密钥 |

## 依赖关系

| 依赖服务 | 说明 |
|----------|------|
| `erp-mysql` | MySQL 数据库 |
| `erp-redis` | Redis 缓存 |

**部署顺序**：`db-app` → `erp-core` → `erp-web` → `nginx-app`
