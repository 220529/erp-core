# å‰ç«¯å­—æ®µå¯¹æ¥è¯´æ˜

## ğŸ”¢ æšä¸¾å¸¸é‡è·å–

### æ–¹å¼ä¸€ï¼šå‰ç«¯ç¡¬ç¼–ç ï¼ˆæ¨èï¼‰âœ…

å¯¹äº**å›ºå®šçš„æšä¸¾å€¼**ï¼ˆä¸ä¼šé¢‘ç¹å˜åŒ–ï¼‰ï¼Œå»ºè®®å‰ç«¯ç›´æ¥å®šä¹‰ï¼š

```typescript
// ç‰©æ–™ç±»åˆ«
export const MaterialCategory = {
  MAIN: 'main',         // ä¸»æ
  AUXILIARY: 'auxiliary', // è¾…æ
  LABOR: 'labor',       // äººå·¥
};

// ç”¨äºä¸‹æ‹‰æ¡†çš„é€‰é¡¹
export const MaterialCategoryOptions = [
  { label: 'ä¸»æ', value: 'main' },
  { label: 'è¾…æ', value: 'auxiliary' },
  { label: 'äººå·¥', value: 'labor' },
];
```

### æ–¹å¼äºŒï¼šé€šè¿‡æ¥å£è·å–ï¼ˆçµæ´»ï¼‰

å¦‚æœéœ€è¦åŠ¨æ€è·å–ï¼Œå¯ä»¥è°ƒç”¨å¸¸é‡æ¥å£ï¼š

```bash
# è·å–ç‰©æ–™ç±»åˆ«
GET /api/constants/material-categories

# è·å–æ‰€æœ‰æšä¸¾å¸¸é‡ï¼ˆä¸€æ¬¡æ€§è·å–ï¼‰
GET /api/constants/all
```

**å¯ç”¨çš„å¸¸é‡æ¥å£ï¼š**
- `/api/constants/material-categories` - ç‰©æ–™ç±»åˆ«
- `/api/constants/material-statuses` - ç‰©æ–™çŠ¶æ€
- `/api/constants/order-statuses` - è®¢å•çŠ¶æ€
- `/api/constants/payment-types` - æ”¶æ¬¾ç±»å‹
- `/api/constants/customer-statuses` - å®¢æˆ·çŠ¶æ€
- `/api/constants/product-statuses` - äº§å“çŠ¶æ€
- `/api/constants/user-roles` - ç”¨æˆ·è§’è‰²
- `/api/constants/all` - æ‰€æœ‰å¸¸é‡ï¼ˆæ¨èåˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰

**è¿”å›æ ¼å¼ï¼š**
```json
{
  "data": [
    { "label": "ä¸»æ", "value": "main", "description": "åœ°æ¿ã€ç“·ç –ã€æ©±æŸœç­‰" },
    { "label": "è¾…æ", "value": "auxiliary", "description": "æ°´æ³¥ã€æ²™å­ã€ç”µçº¿ç­‰" },
    { "label": "äººå·¥", "value": "labor", "description": "æ³¥å·¥ã€æœ¨å·¥ã€æ²¹æ¼†å·¥ç­‰" }
  ]
}
```

---

## ğŸ“‹ æ€»ä½“åŸåˆ™

**åç«¯è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼Œå‰ç«¯ä¸éœ€è¦ä¼ é€’ï¼**

- âœ… **ç¼–ç /ç¼–å·**ï¼šæ‰€æœ‰ codeã€orderNoã€paymentNo ç­‰ç¼–å·å­—æ®µç”±åç«¯è‡ªåŠ¨ç”Ÿæˆ
- âœ… **çŠ¶æ€**ï¼šåˆå§‹çŠ¶æ€ç”±åç«¯è‡ªåŠ¨è®¾ç½®
- âœ… **æ—¶é—´æˆ³**ï¼šcreatedAtã€updatedAt ç”±æ•°æ®åº“è‡ªåŠ¨ç®¡ç†
- âš ï¸ **é‡‘é¢**ï¼šè®¢å•å·²æ”¶é‡‘é¢ paidAmount åˆå§‹ä¸º 0ï¼Œç”±æ”¶æ¬¾ç¡®è®¤åç´¯åŠ 

---

## 1ï¸âƒ£ å®¢æˆ·ç®¡ç†ï¼ˆCustomersï¼‰

### POST /api/customers - åˆ›å»ºå®¢æˆ·

**å‰ç«¯éœ€è¦ä¼ é€’çš„å­—æ®µï¼š**

```typescript
{
  name: string;           // å¿…å¡«ï¼šå®¢æˆ·å§“å
  mobile?: string;        // å¯é€‰ï¼šæ‰‹æœºå·
  address?: string;       // å¯é€‰ï¼šåœ°å€
  area?: string;          // å¯é€‰ï¼šåŒºåŸŸ
  remark?: string;        // å¯é€‰ï¼šå¤‡æ³¨
}
```

**åç«¯è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼š**
- `status`: è‡ªåŠ¨è®¾ç½®ä¸º `lead`ï¼ˆçº¿ç´¢ï¼‰

---

## 2ï¸âƒ£ ç‰©æ–™ç®¡ç†ï¼ˆMaterialsï¼‰

### POST /api/materials - åˆ›å»ºç‰©æ–™

**å‰ç«¯éœ€è¦ä¼ é€’çš„å­—æ®µï¼š**

```typescript
{
  name: string;           // å¿…å¡«ï¼šç‰©æ–™åç§°
  category?: string;      // å¯é€‰ï¼šç‰©æ–™åˆ†ç±»ï¼ˆmain/auxiliary/laborï¼‰
  brand?: string;         // å¯é€‰ï¼šå“ç‰Œ
  spec?: string;          // å¯é€‰ï¼šè§„æ ¼
  unit?: string;          // å¯é€‰ï¼šå•ä½
  costPrice?: number;     // å¯é€‰ï¼šæˆæœ¬ä»·
  salePrice?: number;     // å¯é€‰ï¼šé”€å”®ä»·
  imageUrl?: string;      // å¯é€‰ï¼šå›¾ç‰‡URL
  remark?: string;        // å¯é€‰ï¼šå¤‡æ³¨
}
```

**ğŸ’¡ è¯´æ˜ï¼š**
- **æˆæœ¬ä»·ï¼ˆcostPriceï¼‰**ï¼šé‡‡è´­æˆæœ¬
- **é”€å”®ä»·ï¼ˆsalePriceï¼‰**ï¼šå¯¹å¤–é”€å”®ä»·æ ¼
- ä¸¤ä¸ªä»·æ ¼å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤ä¸º 0

**åç«¯è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼š**
- `code`: æ ¹æ®åˆ†ç±»è‡ªåŠ¨ç”Ÿæˆç¼–ç 

**ç¼–ç è§„åˆ™ï¼š**
| åˆ†ç±» | å‰ç¼€ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| mainï¼ˆä¸»æï¼‰ | ZC | `ZC202510310001` | ä¸»æï¼šåœ°æ¿ã€ç“·ç –ã€æ©±æŸœç­‰ |
| auxiliaryï¼ˆè¾…æï¼‰ | FC | `FC202510310001` | è¾…æï¼šæ°´æ³¥ã€æ²™å­ã€ç”µçº¿ç­‰ |
| laborï¼ˆäººå·¥ï¼‰ | RG | `RG202510310001` | äººå·¥ï¼šæ³¥å·¥ã€æœ¨å·¥ã€æ²¹æ¼†å·¥ç­‰ |

---

## 3ï¸âƒ£ äº§å“å¥—é¤ç®¡ç†ï¼ˆProductsï¼‰

### POST /api/products - åˆ›å»ºäº§å“å¥—é¤

**å‰ç«¯éœ€è¦ä¼ é€’çš„å­—æ®µï¼š**

```typescript
{
  name: string;           // å¿…å¡«ï¼šäº§å“åç§°ï¼ˆå¦‚ï¼šç°ä»£ç®€çº¦ä¸‰å±…å®¤å¥—é¤ï¼‰
  costPrice?: number;     // å¯é€‰ï¼šæˆæœ¬ä»·
  salePrice?: number;     // å¯é€‰ï¼šå”®ä»·
  description?: string;   // å¯é€‰ï¼šäº§å“æè¿°
  status?: string;        // å¯é€‰ï¼šäº§å“çŠ¶æ€ï¼ˆactive/inactiveï¼‰
  sort?: number;          // å¯é€‰ï¼šæ’åº
  remark?: string;        // å¯é€‰ï¼šå¤‡æ³¨
}
```

**åç«¯è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼š**
- `code`: äº§å“ç¼–ç 
- `status`: é»˜è®¤ä¸º `active`ï¼ˆå¯ç”¨ï¼‰
- `costPrice`: é»˜è®¤ä¸º 0
- `salePrice`: é»˜è®¤ä¸º 0
- `sort`: é»˜è®¤ä¸º 0

**ç¼–ç è§„åˆ™ï¼š**
| ç±»å‹ | å‰ç¼€ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| äº§å“å¥—é¤ | CP | `CP202510310001` | äº§å“å¥—é¤ç¼–ç  |

---

## 4ï¸âƒ£ è®¢å•ç®¡ç†ï¼ˆOrdersï¼‰

### POST /api/orders - åˆ›å»ºè®¢å•

**å‰ç«¯éœ€è¦ä¼ é€’çš„å­—æ®µï¼š**

```typescript
{
  customerId: number;     // å¿…å¡«ï¼šå®¢æˆ·ID
  totalAmount?: number;   // å¯é€‰ï¼šè®¢å•æ€»é‡‘é¢
  salesId?: number;       // å¯é€‰ï¼šé”€å”®äººå‘˜ID
  designerId?: number;    // å¯é€‰ï¼šè®¾è®¡å¸ˆID
  foremanId?: number;     // å¯é€‰ï¼šå·¥é•¿ID
  signedAt?: string;      // å¯é€‰ï¼šç­¾çº¦æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  remark?: string;        // å¯é€‰ï¼šå¤‡æ³¨
}
```

**åç«¯è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼š**
- `orderNo`: è®¢å•ç¼–å·
- `status`: åˆå§‹çŠ¶æ€ä¸º `draft`ï¼ˆè‰ç¨¿ï¼‰
- `paidAmount`: å·²æ”¶é‡‘é¢ï¼Œåˆå§‹ä¸º 0

**âŒ å‰ç«¯ä¸è¦ä¼ é€’çš„å­—æ®µï¼š**
- ~~`paidAmount`~~ - å·²æ”¶é‡‘é¢ç”±æ”¶æ¬¾ç¡®è®¤åè‡ªåŠ¨ç´¯åŠ 

**ç¼–ç è§„åˆ™ï¼š**
| ç±»å‹ | å‰ç¼€ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| è®¢å• | DD | `DD202510310001` | è®¢å•ç¼–å· |

---

## 5ï¸âƒ£ æ”¶æ¬¾ç®¡ç†ï¼ˆPaymentsï¼‰

### POST /api/payments - åˆ›å»ºæ”¶æ¬¾è®°å½•

**å‰ç«¯éœ€è¦ä¼ é€’çš„å­—æ®µï¼š**

```typescript
{
  orderId: number;        // å¿…å¡«ï¼šè®¢å•ID
  amount: number;         // å¿…å¡«ï¼šæ”¶æ¬¾é‡‘é¢
  type?: string;          // å¯é€‰ï¼šæ”¶æ¬¾ç±»å‹ï¼ˆdeposit/progress/finalï¼‰
  method?: string;        // å¯é€‰ï¼šæ”¶æ¬¾æ–¹å¼ï¼ˆç°é‡‘/å¾®ä¿¡/æ”¯ä»˜å®ç­‰ï¼‰
  paidAt?: string;        // å¯é€‰ï¼šæ”¶æ¬¾æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  remark?: string;        // å¯é€‰ï¼šå¤‡æ³¨
}
```

**åç«¯è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼š**
- `paymentNo`: æ”¶æ¬¾å•å·
- `status`: åˆå§‹çŠ¶æ€ä¸º `pending`ï¼ˆå¾…ç¡®è®¤ï¼‰
- `type`: é»˜è®¤ä¸º `deposit`ï¼ˆå®šé‡‘ï¼‰

**ç¼–ç è§„åˆ™ï¼š**
| ç±»å‹ | å‰ç¼€ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| æ”¶æ¬¾å• | SK | `SK202510310001` | æ”¶æ¬¾å•å· |

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è°ƒç”¨ï¼ˆerp-codeï¼‰

### POST /api/code/run/:flowKey - æ‰§è¡Œä¸šåŠ¡æµç¨‹

ä¸šåŠ¡æµç¨‹é€šè¿‡ erp-code å®ç°ï¼Œå·²æ›´æ–°ç¼–ç è§„åˆ™ï¼š

#### 1. ä»å¥—é¤åˆ›å»ºè®¢å•
```javascript
POST /api/code/run/order_create_from_product
{
  customerId: 1,
  productId: 1,
  remark: "å®¢æˆ·å¤‡æ³¨"
}
```
**è‡ªåŠ¨ç”Ÿæˆï¼š** `DD202510310001`ï¼ˆè®¢å•ç¼–å·ï¼‰

#### 2. è®¢å•ç­¾çº¦
```javascript
POST /api/code/run/order_sign
{
  orderId: 1,
  depositAmount: 10000,
  paymentMethod: "å¾®ä¿¡"
}
```
**è‡ªåŠ¨ç”Ÿæˆï¼š** `SK202510310001`ï¼ˆæ”¶æ¬¾å•å·ï¼‰

---

## ğŸ“Š ç¼–ç è§„åˆ™æ±‡æ€»è¡¨

| æ¨¡å— | å­—æ®µ | å‰ç¼€ | æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|------|------|
| ç‰©æ–™-ä¸»æ | code | ZC | ZC + YYYYMMDD + 4ä½éšæœºæ•° | `ZC202510310001` | ä¸»æç¼–ç  |
| ç‰©æ–™-è¾…æ | code | FC | FC + YYYYMMDD + 4ä½éšæœºæ•° | `FC202510310001` | è¾…æç¼–ç  |
| ç‰©æ–™-äººå·¥ | code | RG | RG + YYYYMMDD + 4ä½éšæœºæ•° | `RG202510310001` | äººå·¥ç¼–ç  |
| äº§å“å¥—é¤ | code | CP | CP + YYYYMMDD + 4ä½éšæœºæ•° | `CP202510310001` | äº§å“ç¼–ç  |
| è®¢å• | orderNo | DD | DD + YYYYMMDD + 4ä½éšæœºæ•° | `DD202510310001` | è®¢å•ç¼–å· |
| æ”¶æ¬¾ | paymentNo | SK | SK + YYYYMMDD + 4ä½éšæœºæ•° | `SK202510310001` | æ”¶æ¬¾å•å· |

**å‰ç¼€åŠ©è®°ï¼š**
- ZC = ä¸»æ
- FC = è¾…æ
- RG = äººå·¥
- CP = äº§å“ï¼ˆProductï¼‰
- DD = è®¢å•ï¼ˆOrderï¼‰
- SK = æ”¶æ¬¾

---

## âš ï¸ é‡è¦æé†’

### âŒ å‰ç«¯ä¸åº”è¯¥ä¼ é€’çš„å­—æ®µï¼ˆä½†ä¼ äº†ä¹Ÿä¸ä¼šæŠ¥é”™ï¼‰

**åç«¯å·²é…ç½®è‡ªåŠ¨è¿‡æ»¤å¤šä½™å­—æ®µï¼Œä»¥ä¸‹å­—æ®µå³ä½¿ä¼ é€’ä¹Ÿä¼šè¢«è‡ªåŠ¨å¿½ç•¥ï¼š**

1. **æ‰€æœ‰ç¼–ç /ç¼–å·å­—æ®µ**ï¼š
   - `code`ã€`orderNo`ã€`paymentNo` ç­‰
   
2. **ä¸»é”® ID å­—æ®µ**ï¼š
   - æ›´æ–°æ¥å£ä¸­çš„ `id`ï¼ˆå› ä¸º ID å·²åœ¨ URL ä¸­ï¼‰
   
3. **è‡ªåŠ¨ç®¡ç†çš„çŠ¶æ€å­—æ®µ**ï¼š
   - åˆ›å»ºæ—¶çš„åˆå§‹çŠ¶æ€ç”±åç«¯è‡ªåŠ¨è®¾ç½®
   
4. **é‡‘é¢ç´¯è®¡å­—æ®µ**ï¼š
   - `paidAmount`ï¼ˆå·²æ”¶é‡‘é¢ï¼‰- ç”±æ”¶æ¬¾ç¡®è®¤åè‡ªåŠ¨ç´¯åŠ 
   
5. **æ—¶é—´æˆ³å­—æ®µ**ï¼š
   - `createdAt`ã€`updatedAt` - ç”±æ•°æ®åº“è‡ªåŠ¨ç®¡ç†

**ğŸ’¡ æç¤ºï¼š** åç«¯ä½¿ç”¨ `whitelist: true` è‡ªåŠ¨è¿‡æ»¤æœªå®šä¹‰çš„å­—æ®µï¼Œå‰ç«¯ä¼ é€’é¢å¤–å­—æ®µä¸ä¼šæŠ¥é”™ï¼Œåªä¼šè¢«å¿½ç•¥ã€‚

### âœ… å­—æ®µå€¼çº¦å®š

**æ—¥æœŸæ ¼å¼ï¼š** ç»Ÿä¸€ä½¿ç”¨ ISO 8601 æ ¼å¼
```javascript
"2025-10-31T12:00:00.000Z"  // âœ… æ­£ç¡®
"2025-10-31"                 // âœ… ä¹Ÿå¯ä»¥ï¼ˆåªä¼ æ—¥æœŸï¼‰
"2025/10/31"                 // âŒ é”™è¯¯
```

**æšä¸¾å€¼ï¼š** ä½¿ç”¨å°å†™è‹±æ–‡
```javascript
category: "main"       // âœ… æ­£ç¡®
category: "MAIN"       // âŒ é”™è¯¯
category: "ä¸»æ"       // âŒ é”™è¯¯
```

---

## ğŸ”§ åç«¯æ›´æ–°è¯´æ˜

### å·²æ›´æ–°çš„æ–‡ä»¶ï¼š
1. âœ… `materials.service.ts` - ç‰©æ–™ç¼–ç æŒ‰åˆ†ç±»ç”Ÿæˆå‰ç¼€
2. âœ… `products.service.ts` - äº§å“ç¼–ç ä½¿ç”¨ CP å‰ç¼€
3. âœ… `orders.service.ts` - è®¢å•ç¼–å·ä½¿ç”¨ DD å‰ç¼€
4. âœ… `payments.service.ts` - æ”¶æ¬¾å•å·ä½¿ç”¨ SK å‰ç¼€
5. âœ… `create-order.dto.ts` - ç§»é™¤ paidAmount å­—æ®µ
6. âœ… `create-customer.dto.ts` - æ·»åŠ  area å­—æ®µ
7. âœ… `order_create_from_product.js` - æ›´æ–°ç¼–å·ç”Ÿæˆè§„åˆ™
8. âœ… `order_sign.js` - æ›´æ–°ç¼–å·ç”Ÿæˆè§„åˆ™

### éœ€è¦é‡æ–°éƒ¨ç½²ï¼š
```bash
# erp-core é¡¹ç›®
cd E:\frame\erp-core
pnpm run build
pnpm run start:dev

# erp-code é¡¹ç›®ï¼ˆè¿è¡Œä¸Šä¼ è„šæœ¬ï¼‰
cd E:\frame\erp-code
npm run upload
```

---

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

å¦‚æœå‰ç«¯è°ƒç”¨æ¥å£æ—¶é‡åˆ°éªŒè¯é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ˜¯å¦ä¼ é€’äº†ä¸åº”è¯¥ä¼ çš„å­—æ®µï¼ˆå¦‚ codeã€orderNo ç­‰ï¼‰
2. å¿…å¡«å­—æ®µæ˜¯å¦éƒ½å·²ä¼ é€’
3. å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡®ï¼ˆnumber/stringï¼‰
4. æ—¥æœŸæ ¼å¼æ˜¯å¦ç¬¦åˆ ISO 8601
5. æšä¸¾å€¼æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„å°å†™è‹±æ–‡

**å¸¸è§é”™è¯¯ç¤ºä¾‹ï¼ˆå·²ä¿®å¤ï¼‰ï¼š**

~~ä»¥å‰çš„é”™è¯¯ï¼ˆv1.0ä¹‹å‰ï¼‰ï¼š~~
```json
{
  "code": 400,
  "message": [
    "property id should not exist"
  ]
}
```

**âœ… å·²åœ¨ v1.1 ä¿®å¤ï¼š**
- åç«¯ç°åœ¨ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰å¤šä½™çš„å­—æ®µ
- å‰ç«¯ä¼ é€’ `id`ã€`code` ç­‰å­—æ®µä¸ä¼šæŠ¥é”™
- è¿™äº›å­—æ®µä¼šè¢«è‡ªåŠ¨å¿½ç•¥ï¼Œä¸å½±å“æ›´æ–°

**æ¨èåšæ³•ï¼ˆä½†ä¸å¼ºåˆ¶ï¼‰ï¼š**
- æ›´æ–°æ¥å£æ—¶ï¼Œä¸éœ€è¦ä¼ é€’ `id` å­—æ®µï¼ˆID å·²åœ¨ URL ä¸­ï¼‰
- åˆ›å»ºæ¥å£æ—¶ï¼Œä¸éœ€è¦ä¼ é€’ `code` ç­‰è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µ

