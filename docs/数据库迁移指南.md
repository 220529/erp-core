# 数据库迁移指南

## 概述

本项目使用 TypeORM Migration 管理数据库表结构变更，确保生产环境数据安全。

## 工作流程

```
本地开发                                生产环境
   │                                      │
   ▼                                      │
1. 修改 Entity 文件                       │
   │                                      │
   ▼                                      │
2. 生成 migration                         │
   pnpm migration:generate               │
   │                                      │
   ▼                                      │
3. 检查生成的迁移文件                      │
   src/migrations/xxx-migration.ts       │
   │                                      │
   ▼                                      │
4. 本地测试迁移                           │
   pnpm migration:run                    │
   │                                      │
   ▼                                      │
5. 提交代码，推送到 master ───────────────► 6. CI/CD 自动部署
                                          │
                                          ▼
                                    7. 容器启动时自动执行迁移
```

## 常用命令

### 生成迁移（基于 Entity 变更）

```bash
pnpm migration:generate
```

这会比较当前 Entity 与数据库的差异，自动生成迁移文件。

### 创建空迁移（手动编写）

```bash
pnpm migration:create
```

用于复杂场景，如数据迁移、索引优化等。

### 执行迁移

```bash
pnpm migration:run
```

### 回滚迁移

```bash
pnpm migration:revert
```

## 迁移文件示例

```typescript
// src/migrations/1732600000000-AddUserPhone.ts
import { MigrationInterface, QueryRunner } from 'typeorm';

export class AddUserPhone1732600000000 implements MigrationInterface {
    
    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`
            ALTER TABLE user ADD COLUMN phone VARCHAR(20) NULL
        `);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`
            ALTER TABLE user DROP COLUMN phone
        `);
    }
}
```

## 生产环境执行

生产环境部署时，容器启动会自动执行 `scripts/run-migrations.js`：

1. 连接数据库
2. 检查待执行的迁移
3. 执行所有待执行的迁移
4. 启动应用

## 注意事项

1. **永远不要**在生产环境使用 `synchronize: true`
2. 迁移文件一旦执行过，**不要修改**，需要新建迁移
3. 危险操作（删表、删列）请先**备份数据**
4. 复杂迁移建议先在测试环境验证

## 环境配置

| 环境 | synchronize | migration |
|------|-------------|-----------|
| 开发 | true (可选) | 手动执行 |
| 生产 | **false** | 自动执行 |

## 文件结构

```
erp-core/
├── src/
│   ├── database/
│   │   └── data-source.ts      # TypeORM 数据源配置
│   └── migrations/             # 迁移文件目录
│       ├── .gitkeep
│       └── xxx-migration.ts
├── scripts/
│   └── run-migrations.js       # 生产环境迁移脚本
└── docs/
    └── 数据库迁移指南.md         # 本文档
```
