# 数据库迁移指南

## 核心原则

**Entity 是唯一真相源，数据库结构由 Entity 驱动。**

| 环境 | DB_SYNCHRONIZE | 说明                      |
| ---- | -------------- | ------------------------- |
| 开发 | `false`        | 通过 migration 管理表结构 |
| 生产 | `false`        | 部署时自动执行 migration  |

## 开发流程

```bash
# 1. 新增或修改 Entity 文件
# 2. 生成迁移（自动比对 Entity 与数据库差异）
pnpm migration:generate

# 3. 执行迁移（本地数据库创建/修改表）
pnpm migration:run

# 4. 提交代码
git add .
git commit -m "feat: add xxx table"
git push

# 5. 线上自动执行迁移
```

## 常用命令

| 命令                      | 说明                   |
| ------------------------- | ---------------------- |
| `pnpm migration:generate` | 自动生成迁移文件       |
| `pnpm migration:run`      | 执行迁移               |
| `pnpm migration:revert`   | 回滚最后一次迁移       |
| `pnpm migration:create`   | 创建空迁移（手写 SQL） |

## 关键说明

### 为什么 synchronize 必须是 false？

`synchronize=true` 会在应用启动时自动同步 Entity 到数据库，导致：

- Entity 和数据库已经一致
- `migration:generate` 检测不到差异，无法生成迁移文件
- 线上部署时没有迁移文件可执行

### 迁移文件位置

```
erp-core/
├── src/migrations/           ← 迁移文件目录
│   └── 1733750400000-CreateFilesTable.ts
└── scripts/
    └── run-migrations.js     ← 生产环境迁移脚本
```

## 生产部署

容器启动时自动执行 `scripts/run-migrations.js`：

1. 连接数据库
2. 检查 `typeorm_migrations` 表，找出未执行的迁移
3. 执行迁移
4. 启动应用

## 注意事项

- 迁移文件一旦 push 到线上执行过，**不要修改**，需要新建迁移
- 危险操作（删表、删列）先**备份数据**
- 不要直接在数据库手动改表结构，会导致 Entity 和数据库不一致
